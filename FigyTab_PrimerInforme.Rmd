---
title: "Figuras y Tablas para Tercer Informe de sardina común Centro sur "
output:
  pdf_document: default
---


```{r llama codigos, warning=F, include=T, message=F, echo=FALSE}
library(knitr) # para generar reporte Rmarkdown
library(stringr)
library(reshape) 
library(dplyr) 
library(ggplot2)
library(ggthemes) # para ggplot
library(patchwork) # para unir gráficos de ggplot
library(strucchange) # libreria utilizada para análisis de quiebres

dir.Fig     <-"Figuras/" # carpeta de las figuras utilizadas y generadas en este estudio
fig         <-c("pdf") # formato de figuras generadas por este código
dir.0       <-getwd() # directorio de trabajo 
dir.1       <-paste(dir.0,"/codigos_admb",sep="") # carpeta de códigos ADMB 
dir.2       <-paste(dir.0,"/codigos_admb_12.3_windows",sep="") # carpeta de códigos ADMB 
dir.fun     <-paste(dir.0,"/funciones/",sep="") # carpeta de funciones utilizadas en este informe
source(paste(dir.fun,"functions.R",sep="")) # funciones para leer .dat y .rep
source(paste(dir.fun,"Fn_PBRs.R",sep="")) # funciones para leer .dat y .rep
ant <-reptoRlist(paste(dir.0,"/DatosEntrada.dat",sep=""))  # datos utilizados para antecedentes

```

```{r CORRE MODELO BASE SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0921")
system("./MAE0921")
```

```{r CORRE MODELO BASE MARZO, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0321")
system("./MAE0321")
```

```{r CORRE MODELO BASE JULIO, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0721")
system("./MAE0721")
```


```{r  leer datos, echo=FALSE, warning=FALSE, include=T}
setwd(dir.1)

# ASESORÍA DE SEPTIEMBRE
data1        <- lisread("MAE0921.dat") 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1
rep1         <- reptoRlist("MAE0921.rep")
std1         <- read.table("MAE0921.std",header=T,sep="",na="NA",fill=T) 

# ASESORÍA DE MARZO
data2        <- lisread("MAE0321.dat") 
names(data2) <- str_trim(names(data2), side="right")
dat2         <- data2
rep2         <- reptoRlist("MAE0321.rep")
std2         <- read.table("MAE0321.std",header=T,sep="",na="NA",fill=T) 

# ASESORÍA DE JULIO
data3        <- lisread("MAE0721.dat") 
names(data3) <- str_trim(names(data3), side="right")
dat3         <- data3
rep3         <- reptoRlist("MAE0721.rep")
std3         <- read.table("MAE0721.std",header=T,sep="",na="NA",fill=T) 

```


```{r Retrospectivo_sept, echo=F, warning=FALSE,eval=F, include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAE0921",
              dir.0,
              dir.1,
              "/Retrospectivo_sept",
              system="mac") 
```

```{r Retrospectivo_marzo, echo=F, warning=FALSE,eval=F, include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAE0321",
              dir.0,
              dir.1,
              "/Retrospectivo_marz",
              system="mac") 
```

```{r Retrospectivo_julio, echo=F, warning=FALSE,eval=F, include=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAE0721",
              dir.0,
              dir.1,
              "/Retrospectivo_jul",
              system="mac") 
```



```{r Verosimilitud_sept, echo=F, warning=F,eval=F, include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 11.6
factor    <- seq(0.2,2,0.08)
priorRo  <- log(exp(logRo)*factor)

Verosimilitud("MAE0921",
              dir.0,
              dir.1,
              "/Verosimilitud_sept",
              logRo,
              priorRo,
              system="mac") 
```

```{r Verosimilitud_marz, echo=F, warning=F,eval=F, include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 11.6
factor    <- seq(0.2,2,0.08)
priorRo  <- log(exp(logRo)*factor)

Verosimilitud("MAE0321",
              dir.0,
              dir.1,
              "/Verosimilitud_marz",
              logRo,
              priorRo,
              system="mac") 
```

```{r Verosimilitud_jul, echo=F, warning=F,eval=F, include=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 11.6
factor    <- seq(0.2,2,0.08)
priorRo  <- log(exp(logRo)*factor)

Verosimilitud("MAE0721",
              dir.0,
              dir.1,
              "/Verosimilitud_jul",
              logRo,
              priorRo,
              system="mac") 
```




```{r PRIMER PASO CBA ASESORIA SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
source(paste(dir.fun,"Fn_CBA.R",sep=""))
CBA(dir.0,
    dir.1,
    Carpeta="/CBA_sept", #genera carpeta con escenarios de reclutamiento para el cálculo de CBA
    admb="MAE0921", #códigos .dat y .tpl de asesoría de septiembre
    l_opt_proy=330, # línea  de opción de proyección que se debe cambiar
    l_opRec=336,    # línea  de opción de escenario de reclutamiento promedio que se debe cambiar 
    l_opt_wmed=342, # línea de opción de escenario de peso medio que se debe cambiar para la projección
    l_opt_Str=333,  # linea de opción de estrategia de captura 
    l_mf=345,       # línea de opción de multiplicador de F que se puede cambiar
    opt_proy=2,     # Proyecta de un año para otro (CBA inicial, asesoría de septiembre)
    opt_wmed=3,     # peso promedio últimos 5 años de la serie
    opt_Str=1,      # estrategia F constante
    system="mac")   # denpende si estoy en computador de windows o mac
```

```{r PRIMER PASO CBA ASESORIA MARZO, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
source(paste(dir.fun,"Fn_CBA.R",sep=""))
CBA(dir.0,
    dir.1,
    Carpeta="/CBA_marzo", #genera carpeta con escenarios de reclutamiento para el cálculo de CBA
    admb="MAE0321", #códigos .dat y .tpl de asesoría de marzo
    l_opt_proy=330, # línea  de opción de proyección que se debe cambiar
    l_opRec=336,    # línea  de opción de escenario de reclutamiento promedio que se debe cambiar 
    l_opt_wmed=342, # línea de opción de escenario de peso medio que se debe cambiar para la projección
    l_opt_Str=333,  # linea de opción de estrategia de captura 
    l_mf=345,       # línea de opción de multiplicador de F que se puede cambiar
    opt_proy=1,     # IMPORTANTE!! Proyecta para el mismo año (1era y 2da revisión de CBA, asesorías de marzo y julio)
    opt_wmed=3,     # peso promedio últimos 5 años de la serie
    opt_Str=1,      # estrategia F constante
    system="mac")   # denpende si estoy en computador de windows o mac
```

```{r PRIMER PASO CBA ASESORIA JULIO, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
source(paste(dir.fun,"Fn_CBA.R",sep=""))
CBA(dir.0,
    dir.1,
    Carpeta="/CBA_julio", #genera carpeta con escenarios de reclutamiento para el cálculo de CBA
    admb="MAE0721", #códigos .dat y .tpl de asesoría de julio
    l_opt_proy=330, # línea  de opción de proyección que se debe cambiar
    l_opRec=336,    # línea  de opción de escenario de reclutamiento promedio que se debe cambiar 
    l_opt_wmed=342, # línea de opción de escenario de peso medio que se debe cambiar para la projección
    l_opt_Str=333,  # linea de opción de estrategia de captura 
    l_mf=345,       # línea de opción de multiplicador de F que se puede cambiar
    opt_proy=1,     # IMPORTANTE!! Proyecta para el mismo año (1era y 2da revisión de CBA, asesorías de marzo y julio)
    opt_wmed=3,     # peso promedio últimos 5 años de la serie
    opt_Str=1,      # estrategia F constante
    system="mac")   # denpende si estoy en computador de windows o mac
```



```{r TamañosMuestra, eval=FALSE, echo=FALSE, warning=FALSE, include=T}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0921")
system("./MAE0921")

#------------------------------------------------
dat.file   = "MAE0921.dat"
data.0        <- lisread(paste(dir.1,dat.file, sep='/'));
names(data.0) <-  str_trim(names(data.0), side="right")
data.1        <- data.0
rep           <- reptoRlist("MAE0921.rep")                                               
std           <- read.table("MAE0921.std",header=T,sep="",na="NA",fill=T) 

#---------------------------------------
# ============================================================================== #
# I. INDICES DE ABUNDANCIA                                                       #
# ============================================================================== #
years  <- data.1$Ind[,1]                                                              
nyears <- data.1$nanos                                                                
age    <- seq(0,4,1)                    
nage   <- data.1$nedades                                                            
Amax   <- data.1$nedades        
Age    <- seq(0,4,1) 
    

x  <-c(years,rev(years))
x1 <-c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2 <-c(years[1]-1,years[nyears]+1) #xlim

#============================================================#
# II. COMPOSICI?N EDAD DE LAS CAPTURAS                       #
#============================================================#
#age <-dat$"#Edades"                                         
age  <-seq(0,4,1)                                            
nage<-length(age)                                            
#Proporci?n observada                                        
pobsF<-rep$pf_obs                                              
pobsR<-rep$pobs_RECLAS                                       
pobsP<-rep$pobs_PELACES                                      
#Proporci?n predicha                                         
ppredF<-rep$pf_pred                                          
ppredR<-rep$ppred_RECLAS                                     
ppredP<-rep$ppred_PELACES                                    
resfl <-matrix(ncol=nage,nrow=nyears)                         
for(i in 1:nyears){                                          
	for(j in 1:nage){                                          
		resfl[,j]<-pobsF[,j]-ppredF[,j]}}                        
#Proporciones                                                
pF   <- c(pobsF,ppredF); pF[pF==0]  <-NA                     
pR   <- c(pobsR,ppredR); pR[pR==0]  <-NA                     
pP   <- c(pobsP,ppredP); pP[pP==0]  <-NA                     
#arreglos                                                    
edad <- rep(gl((length(age)),length(years),label=age),2)     
años <- rep(years,length(age)*2)                             
ind  <- c(rep("capt_obs",length(years)*length(age)),         
	rep("capt_est",length(years)*length(age)))        
pro  <- data.frame(años,edad,ind,pF,pR,pP)    
# ==========================================================================

#=================================================================#
# M?TODO de Francis
#=================================================================#
Nf1 <-60
Nr1 <-34
Np1 <-6
#-------------------------------------------#
#FLOTA
fanos<-years
fobs <-pobsF
fpre <-ppredF 
#RECLAS
ranos<-years
robs <-pobsR[rowSums(pobsR)>0,]
rpre <-ppredR[rowSums(pobsR)>0,]
#PELACES
panos<-years
pobs <-pobsP[rowSums(pobsP)>0,]
ppre <-ppredP[rowSums(pobsP)>0,] 

Of  <- rep(0,length(fanos))
Ef  <- rep(0,length(fanos))
vf  <- rep(0,length(fanos))
vNf <- rep(0,length(fanos))

Or  <- rep(0,length(robs[,1]))
Er  <- rep(0,length(robs[,1]))
vr  <- rep(0,length(robs[,1]))
vNr <- rep(0,length(robs[,1]))

Op  <- rep(0,length(pobs[,1]))
Ep  <- rep(0,length(pobs[,1]))
vp  <- rep(0,length(pobs[,1]))
vNp <- rep(0,length(pobs[,1]))
#-------------------------------------------#
for(i in 1:length(fanos)){
	Of[i]  <- sum(fobs[i,]*age)
	Ef[i]  <- sum(fpre[i,]*age)
	vf[i]  <- sum(fpre[i,]*age^2)-Ef[i]^2
	vNf[i] <- vf[i]/Nf1}

for(i in 1:length(robs[,1])){
	Or[i]  <- sum(robs[i,]*age)
	Er[i]  <- sum(rpre[i,]*age)
	vr[i]  <- sum(rpre[i,]*age^2)-Er[i]^2
	vNr[i] <- vr[i]/Nr1}

for(i in 1:length(pobs[,1])){
	Op[i]  <- sum(pobs[i,]*age)
	Ep[i]  <- sum(ppre[i,]*age)
	vp[i]  <- sum(ppre[i,]*age^2)-Ep[i]^2
	vNp[i] <- vp[i]/Np1}
#--------------------------------------------#
wf  <- 1/var((Of-Ef)/sqrt(vNf)) 
wr  <- 1/var((Or-Er)/sqrt(vNr)) 
wp  <- 1/var((Op-Ep)/sqrt(vNp))

Nf2 <- Nf1*wf                   # NM FLOTA
Nr2 <- Nr1*wr                   # NM RECLAS
Np2 <- Np1*wp                   # NM PELACES
#-----------------------------------------------------------------#
NM_Fran <- data.frame(nmF=c(Nf1,Nf2),nmR=c(Nr1,Nr2),nmP=c(Np1,Np2));NM_Fran
#-----------------------------------------------------------------#

#=================================================================#
# M?todo de Ianelli 2002
#=================================================================#
Ofl <-ppredF[rowSums(pobsF)>0,]*(1-ppredF[rowSums(pobsF)>0,])
Efl <-(pobsF[rowSums(pobsF)>0,]-ppredF[rowSums(pobsF)>0,])^2
wfl <-rep(0,length(Ofl[,1]))
for(i in 1:length(Ofl[,1])){
	wfl[i] <-sum(Ofl[i,])/sum(Efl[i,])}

nmf_ari <-mean(wfl)                      # MEDIA ARITMETICA
nmf_geo <-exp(sum(log(wfl))/length(wfl)) # MEDIA GEOM?TRICA
nmf_arm <-1/mean(1/wfl)                  # MEDIA ARM?NICA

#------------------------------------------------------------
Ore <-ppredR[rowSums(pobsR)>0,]*(1-ppredR[rowSums(pobsR)>0,])
Ere <-(pobsR[rowSums(pobsR)>0,]-ppredR[rowSums(pobsR)>0,])^2
wre <-rep(0,length(Ore[,1]))
for(i in 1:length(Ore[,1])){	
	wre[i] <-sum(Ore[i,])/sum(Ere[i,])}
nmr_ari <-mean(wre)                      # MEDIA ARITMETICA
nmr_geo <-exp(sum(log(wre))/length(wre)) # MEDIA GEOM?TRICA
nmr_arm <-1/mean(1/wre)                  # MEDIA ARM?NICA
#------------------------------------------------------------
Ope <-ppredP[rowSums(pobsP)>0,]*(1-ppredP[rowSums(pobsP)>0,])
Epe <-(pobsP[rowSums(pobsP)>0,]-ppredP[rowSums(pobsP)>0,])^2
wpe <-rep(0,length(Ope[,1]))
for(i in 1:length(Ope[,1])){
	wpe[i] <-sum(Ope[i,])/sum(Epe[i,])}

nmp_ari <-mean(wpe)                      # MEDIA ARITMETICA
nmp_geo <-exp(sum(log(wpe))/length(wpe)) # MEDIA GEOM?TRICA
nmp_arm <-1/mean(1/wpe)                  # MEDIA ARM?NICA
#------------------------------------------------------------
#------------------------------------------------------------
NM_Ian <- data.frame(nmF=c(nmf_ari,nmf_geo,nmf_arm),
                     nmR=c(nmr_ari,nmr_geo,nmr_arm),
                     nmP=c(nmp_ari,nmp_geo,nmp_arm))
kable(NM_Ian)
#------------------------------------------------------------

```

\footnotesize
# 1. ANTECEDENTES

```{r Fig2, echo=F,warning=F, include=T,eval=F, message=F,fig.height=3.5,fig.width=6.5,fig.align="center",fig.path=dir.Fig,dev=fig}
years<-seq(1990,2020,1)
dataDesem  <- ant$des_oficialesvscorregidos
Tdesem     <- data.frame(years,dataDesem[,1:2],rep(median(dataDesem[,2]),length(dataDesem[,2])))
colnames(Tdesem) <- c("Years", 
                      "Desembarques_oficiales", 
                      "Desembarques_oficales_corregidos",
                      "Mediana_desembarques_corregidos")

des_Of_corr <- data.frame(Tdesem) %>% mutate(Registros="desembarques") %>% melt(id.var=c("Years","Registros"))

ggplot(des_Of_corr)+
  geom_line(aes(Years,value/1000,colour=variable))+
  annotate("text", x=2011, y=(round(median(Tdesem[,3]),0)/1000)+30,
  label=paste(round(median(Tdesem[,3]/1000),0),"mil toneladas"))+
  scale_colour_manual(values=c('blue',"black","red")) +
  labs(x = '', y = 'Desembarques (miles de toneladas)',colour="") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 2)) +
  theme_bw(base_size=9) + 
  theme(plot.title = element_text(hjust = 0.5),legend.position="top")

```

\pagebreak

```{r Fig3, echo=F,warning=F, include=T, message=F,fig.height=3.3,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig}
dataDesem2  <- data.frame(ant$year_cuota,ant$des_art,ant$des_ind)
colnames(dataDesem2) <- c("Years", 
                      "Desembarque_artesanal", 
                      "Desembarque_industrial")

dataDesem3  <- data.frame(ant$year_cuota,
                          ant$cuot_art,
                          ant$cuot_ind)

colnames(dataDesem3) <- c("Years",
                      "Cuota_artesanal", 
                      "Cuota_industrial")

des_art_ind   <- data.frame(dataDesem2) %>% 
                          mutate(Registros="desembarques") %>% 
                          melt(id.var=c("Years","Registros"))

cuota_art_ind <- data.frame(dataDesem3) %>% 
                            mutate(Registros=c("cuotas")) %>% 
                            melt(id.var=c("Years","Registros"))

ggplot(des_art_ind)+
  geom_bar(aes(x=Years, y =value/1000,fill=variable), stat="identity",color = 'gray70') + 
  geom_line(data = cuota_art_ind, aes(x = Years, y = value/1000, colour=variable)) +
  scale_fill_manual(values=c('gray70',"gray50")) +
  scale_color_manual(values=c('black',"red")) +
  labs(x = '', y = 'Miles de toneladas',fill="",color="") +
  scale_x_continuous(breaks = seq(from = 2000, to = 2020, by = 2)) +
  theme_bw(base_size=8.9) + 
  theme(plot.title = element_text(hjust = 0.5),legend.position="top")
```

\pagebreak

```{r Fig4,warning=F, include=T, message=F, echo=T,fig.height=3.3,fig.width=5.8,fig.align="center",fig.path=dir.Fig,dev=fig}
ano<-ant$desembarques_sernapesca[,1]
des_mes<-data.frame(mes=rep(seq(1,12,1),27),
                    ano=gl(27,12,labels=ano),
                    desem=c(t(ant$desembarques_sernapesca[,2:13])))

par(mfcol=c(1,1),mar=c(4,4,1,1))
boxplot(des_mes$desem[145:264]/10^3~des_mes$mes[145:264],las=1,xlab="Mes",
	ylab="Desembarques (miles de t)",col="lightyellow3")
```

\pagebreak


```{r Fig7, warning=F, include=T, message=F, echo=F,fig.height=4.5,fig.width=4.5,fig.align="center",fig.path=dir.Fig,dev=fig}

x<-rep1$reclasobs[rep1$reclasobs>0&rep1$pelacesobs>0]/10^6
y<-rep1$pelacesobs[rep1$reclasobs>0&rep1$pelacesobs>0]/10^6
years<-rep1$years

par(mar=c(4,4,1,1))
plot(x,y,las=1,cex=1.5,xlab="Crucero de verano (t.*10^6)",ylab="Crucero de otoño (t.*10^6)",xlim=c(0,5),ylim=c(0,3),cex.lab=0.8,cex.axis=0.8)
text(x,y-0.09,years[rep1$reclasobs>0&rep1$pelacesobs>0],cex=0.7,col=4)

model0<-lm(y~x)
y0<-predict(model0,data.frame(x=seq(0,4,0.1)),interval="prediction",level = 0.98)
lines(seq(0,4,0.1),y0[,1],col=2)
#summary(model0)
text(2,3,paste("Y =",round(model0$coefficients[1],4),"+",round(model0$coefficients[2],3),"X",sep=""),col=4,cex=0.8)
text(2.1,2.8, "R^2=0.00039",col=4,cex=0.8)

```
\pagebreak

```{r Fig8,warning=F, include=T, message=F, echo=F,fig.height=3.5,fig.width=10,fig.align="center",fig.path=dir.Fig,dev=fig}

anorecl<-ant$reclas_BT_BR_AT_AR[,1]
BTreclas<-ant$reclas_BT_BR_AT_AR[,2]
BRreclas<-ant$reclas_BT_BR_AT_AR[,3]
ATreclas<-ant$reclas_BT_BR_AT_AR[,4]
ARreclas<-ant$reclas_BT_BR_AT_AR[,5]
anopela<-ant$pelaces_BT_AT[,1]
BTpela<-ant$pelaces_BT_AT[,2]
ATpela<-ant$pelaces_BT_AT[,3]

par(mfcol=c(1,2),mar=c(4,4,1,1))
plot(anorecl,BTreclas/1000,ylim=c(0,5000),xaxp=c(2000,2021,21),las=1,ylab="Biomasa (tx1000)",xlab="",type="o",pch=19,col=1,lwd=2,cex.lab=0.8,cex.axis=0.8)
lines(anorecl,BRreclas/1000,type="o",pch=19,col=2,lwd=2)
legend(2000, 5000,c("Biomada Total","Biomasa Reclutas"),pch=19,lwd=2,col=c(1,2),bty="n",cex=0.8)

plot(anorecl,ATreclas/1000,ylim=c(0,2000),xaxp=c(2000,2021,21),las=1,ylab="Abundancia (nº ind x10^9)",xlab="",type="o",pch=19,col=1,lwd=2,cex.lab=0.8,cex.axis=0.8)
lines(anorecl,ARreclas/1000,type="o",pch=19,col=2,lwd=2)
legend(2000, 2000,c("Abundancia Total","Abundancia Reclutas"),pch=19,lwd=2,col=c(1,2),bty="n",cex=0.8)

```


```{r Fig6b, echo=FALSE,fig.height=5,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig}
years<-seq(1997,2021)
sardina<-c(0.80,0.43,0.38,0.24,0.15,0.31,0.33,0.27,0.16,0.21,0.77,0.68,1.57,1.10,
           1.15,1.42,1.36,1.07,1.57,1.28,1.04,1.13,1.62,1.06,0.62)
anchoveta<-c(0.92,0.50,0.56,0.54,0.63,1.08,1.54,1.90,1.64,1.76,1.85,1.30,0.82,
             0.43,0.18,0.15,0.16,0.21,0.27,0.30,0.46,0.57,0.7,0.99,1.30)

dataEstatus <- data.frame(years,sardina,anchoveta) %>% mutate(type=c("Estatus")) %>% melt(id.var=c("years","type"))

ggplot(dataEstatus )+
  geom_line(aes(x = years, y = value, colour=variable)) +
  scale_color_manual(values=c('black',"red")) +
  labs(x = '', y = 'BD/BDrms',fill="",color="") +
  scale_x_continuous(breaks = seq(from = 1997, to = 2022, by = 2)) +
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5),legend.position="top")

```



\pagebreak

# 2. METODOLOGÍA

```{r Fig15,  warning=F, include=T, message=F, echo=F,fig.height=3,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig}
library(strucchange)
years     <- rep1$years
nyears    <- length(years)
bp.nile   <- breakpoints(rep1$Reclutas/1000 ~ 1)
fm0       <- lm(rep1$Reclutas/1000 ~ 1)
fm1       <- lm(rep1$Reclutas/1000 ~ breakfactor(bp.nile, breaks = 2))
quiebres3 <- fitted(fm1)

par(mfrow=c(1,1),mar=c(2,4,1,1))
plot(years,rep1$Reclutas/1000,type="l",lty=2,pch=19,ylim=c(0,700),
     xaxp=c(1990,2021,31),yaxs="i",xlab="",ylab="Reclutamientos (miles de millones de ind.)",main="Análisis de quiebres",cex.main=0.8,cex.axis=0.7,cex.lab=0.7)
points(years,rep1$Reclutas/1000,col=1,pch=19)
lines(years,quiebres3,lwd=2,col=4)
text(c(1999,2010,2017),
     c(fitted(fm1)[1],
      fitted(fm1)[18],
      fitted(fm1)[23])+25,
     round(c(fitted(fm1)[1],
             fitted(fm1)[18],
             fitted(fm1)[23]),0),
     col=2,font=1,cex=0.8)
```

\pagebreak

```{r Fig16,warning=F, include=T, message=F, echo=F,fig.height=4.5,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}
years1  <-rep1$years
nyears1 <-length(years1)
age     <-seq(0,4,1)                                            
nage    <-length(age)
pobsF   <-rep3$pf_obs 
  
#Proporcion observada                                        
WmedF <-dat1$Wmed                                             
WiniF <-dat1$Wini                                 
#Proporciones                                                
Wm    <-c(WmedF); 
Wm[Wm==0]  <-NA                     
Wi    <-c(WiniF); 
Wi[Wi==0]  <-NA 

x1 <-c(years1[1],years1[nyears1]+1,nyears1+1/2)
#Proporci?n de edad
par(mar=c(4,4,2,1),mfrow=c(1,2))
# pesos medios
plot(years1,WmedF[,1],type="n",las=1,ylim=c(0,75),xlim=c(1990,years1[nyears1]),
     ylab="Pesos medios (grs)",xlab="",xaxp=x1,main="")
for(i in 1:5){
lines(years1,WmedF[,i],col=i,type="o", pch=19)}
legend(1990,75,c("edad 0","edad 1","edad 2","edad 3","edad 4"),pch=19,lwd=1,col=1:5,bty="n")


plot(age,colMeans(WmedF),type="o",pch=19,ylab="Pesos medios (grs)",xlab="Edad (años)")
lines(age,colMeans(WmedF[(nyears1-5):nyears1,]),col=2,type="o",pch=19)
legend(0,35,c("peso medio histórico","peso medio últimos 5 años"),pch=19,lwd=1,col=c(1,2),bty="n")
```

\pagebreak

```{r desembarques y descarte, echo=FALSE,eval=T}
bioyear<-c("1990-91","1991-92","1992-93","1993-94","1994-95","1995-96","1996-97","1997-98","1998-99","1999-00","2000-01",
           "2001-02","2002-03","2003-04","2004-05","2005-06","2006-07","2007-08","2008-09","2009-10","2010-11","2011-12",
           "2012,13","2013-14","2014-15","2015-16","2016-17","2017-18","2018-19","2019-20","2020-21")
desemYdesc_previo<-c(494567,514787,250237,358949,120608,361735,552515,73892,212993,205616,52469,317467,293654,387597,252695,
              516296,358380,742168,942051,627588,828172,859565,418607,520667,417249,300574,407403,355545,319650,289779,391294.5)
desc_previo<-c(rep(1,10),rep(1.04,16),rep(1.02,2),rep(1.06,2),1.04)
desembarque<-desemYdesc_previo/desc_previo

desc_actualizado<-c(rep(1,10),rep(1.04,17),1.07,1.05,1.04,1.04)
CapturaDescartada<- -(1-desc_actualizado)*desembarque
CapturaTotal<-desembarque+CapturaDescartada

porcDesc_actualizado<-c(rep("0%",10),rep("4%",17),"7%","5%","4%","4%")

data<-data.frame("Año biológico"=bioyear,
                 "Desembarques t."=round(desembarque,0),
                 "Porcentaje descarte" =porcDesc_actualizado,
                 "Captura descartada t."=round(CapturaDescartada,0),
                 "Captura total t."=round(CapturaTotal,0))

kable(data, align = 'c')

write.csv(data, file="Tablas/DatosCapturaydescarte.csv")

```


\pagebreak
# 3. RESULTADOS


```{r Fig19, warning=F, include=T, message=F, echo=F,fig.height=4.5,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig}
setwd(dir.1)
years  <- rep1$years 
nyears <- dat1$nanos                                                                
x2      <-c(years,rev(years))
x1_2    <-c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2_2    <-c(years[1]-1,years[nyears]+1) #xlim

ydesembarques<-rep1$years[rep1$desembarqueobs>0]
yreclas      <-rep1$years[rep1$reclasobs>0]
ypelaces     <-rep1$years[rep1$pelacesobs>0]
ycompflota   <-rep1$years[rowSums(rep1$pf_obs)>0]
ycompreclas  <-rep1$years[rowSums(rep1$pobs_RECLAS)>0]
ycomppelaces <-rep1$years[rowSums(rep1$pobs_PELACES)>0]
ypesomedio   <-rep1$years[rowSums(dat1$Wmed)>0]
ypesoinicial <-rep1$years[rowSums(dat1$Wini)>0]

par(mfrow=c(1,1),mar=c(2,2,1,1)+0.5)
plot(years,rep(0,length(years)),type="n",ylim=c(0,9),ylab="",xlab="",xaxp=x1_2,axes=F,xlim=c(1991,2027.5))
abline(v=2022)
points(ydesembarques,rep(1,length(ydesembarques)),lwd=15,col=1)
points(yreclas,rep(2,length(yreclas)),lwd=15,col=2)
points(ypelaces,rep(3,length(ypelaces)),lwd=15,col=3)
points(ycompflota,rep(4,length(ycompflota)),lwd=15,col=4)
points(ycompreclas,rep(5,length(ycompreclas)),lwd=15,col=5)
points(ycomppelaces,rep(6,length(ycomppelaces)),lwd=15,col=6)
points(ypesomedio,rep(7,length(ypesomedio)),lwd=15,col=7)
points(ypesoinicial,rep(8,length(ypesoinicial)),lwd=15,col=8)

ejey<-c("Desembarques","Biom_Cru_verano","Biom_Cru_otoño","CompEdad Flota","CompEdad C.verano","CompEdad C.otoño","Peso medio Flota","Peso inicial Flota")

#legend()
axis(1,years,xaxp=x1_2)
text(rep(2025.5,8),1:8,ejey,cex=0.8)

box()
```

\pagebreak

```{r Fig20, warning=F, include=T, message=F, echo=F,fig.height=8,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig}
 
des_obs <- data.frame(rep1$desembarqueobs)
bc_obs  <- data.frame(rep1$reclasobs)
bp_obs  <- data.frame(rep1$pelacesobs)
yearc   <- rep1$years 
nyearc  <-length(yearc)  

 obsC  <- as.data.frame(bc_obs) %>% 
                        mutate(year=yearc) %>% 
                        melt(id.vars='year') %>% 
                        mutate(type='2.Cruceros de Verano')
 obsP  <- as.data.frame(bp_obs) %>% 
                        mutate(year=yearc) %>% 
                        melt(id.vars='year') %>% 
                        mutate(type='3.Cruceros de Otoño')
 obsD  <- as.data.frame(des_obs) %>% 
                        mutate(year=yearc) %>% 
                        melt(id.vars='year') %>% 
                        mutate(type='1.Desembarques')
 Bcru  <-rbind(obsC,obsP,obsD)

p <- ggplot()  +
     geom_bar(data=Bcru, aes(x=year, y =value), stat="identity", fill='gray66',color = 'gray28') + 
     facet_wrap(~type,scale="free",dir = 'v', as.table = TRUE) + 
      labs(x="Años", y="Toneladas")
p +  theme(panel.background = element_rect(fill ="gray99")) + 
      theme(panel.grid=element_line(color="gray66"))



```

```{r indices, echo=FALSE,eval=T}

dataInd<-dat1$Ind
write.csv(dataInd, file="Tablas/Datosindices.csv")
dataInd

```

\pagebreak

```{r Fig21, warning=F, include=T, message=F,eval=T, echo=F,fig.height=4,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}

years    <- rep1$years 
nyears   <- length(years)
age      <- seq(0,4,1)                                            
nage     <- length(age)
WmedF    <- dat1$Wmed                                             
WiniF    <- dat1$Wini    
pobsF    <- rep1$pf_obs                                              

WmedF <- as.data.frame(WmedF) %>% 
                      mutate(years=years) %>% 
                      melt(id.vars='years') %>%             
                      mutate(edad = rep(age, each=nyears)) %>% 
                      mutate(type='WmedF')

pobsF <- as.data.frame(pobsF) %>% 
                      mutate(years=years) %>% 
                      melt(id.vars='years') %>%             
                      mutate(edad = rep(age, each=nyears)) %>% 
                      mutate(type='pobsF')


f1<-ggplot(pobsF, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Proporción de captura en N° a la edad',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
  scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
  ggtitle("FLOTA")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<-ggplot(WmedF, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Pesos medios (grs)',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
  scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
   ggtitle("FLOTA")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5))

f1 + f2

```
\pagebreak

```{r Fig22,warning=F, include=T, message=F, echo=F,fig.height=6,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}
pobsF    <- rep1$pf_obs      
pF       <- c(pobsF); pF[pF==0]  <-NA
WmedF    <- dat1$Wmed    
Wm       <- c(WmedF); Wm[Wm==0]  <-NA     

years    <- rep1$years 
nyears   <- dat1$nanos
age      <- seq(0,4,1)                                            
nage     <- length(age)

anos <- rep(years,length(age)) 
edad <- gl((length(age)),length(years),label=age)   

datosProp=data.frame(x=edad,y=anos,tamanio=pF)
datosWmed=data.frame(x=edad,y=anos,tamanio=Wm )

g1 <- ggplot (datosProp,aes(x,y)) +
     geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha = 0.7) +
     scale_size_continuous(breaks = seq(0.05,0.65,0.2),range=c(0,6))+
     labs(x = 'Edades', y = 'Años',size="Proporción") +
     ggtitle("Proporción de edad de la Flota")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5))

g2 <- ggplot (datosWmed,aes(x,y)) + 
      geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha=0.7) +
      scale_size_continuous(breaks = seq(15,75,20),range=c(0,6))+
      labs(x = 'Edades', y = 'Años',size="Gramos") +
      ggtitle("Pesos medios de la Flota")+
      theme_bw(base_size=11) + 
      theme(plot.title = element_text(hjust = 0.5))

g1 + g2

```
\pagebreak

```{r Fig23, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}

years    <- rep1$years 
nyears   <- dat1$nanos
age      <- seq(0,4,1)                                            
nage     <- length(age)
pobsR1    <- rep1$pobs_RECLAS                                               
pobsP1    <- rep1$pobs_PELACES 


pobsR <- as.data.frame(pobsR1) %>% 
                       mutate(years=years) %>% 
                       melt(id.vars='years') %>%            
                       mutate(edad = rep(age, each=nyears)) %>% 
                       mutate(type='pobsR')

pobsP <- as.data.frame(pobsP1) %>% 
                       mutate(years=years) %>% 
                       melt(id.vars='years') %>%             
                       mutate(edad = rep(age, each=nyears)) %>% 
                       mutate(type='pobsP')


f1<-ggplot(pobsR, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Proporción de captura en N° a la edad',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
    scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
  ggtitle("CRUCERO DE VERANO")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<-ggplot(pobsP, aes(x = years, y = value, group=variable,colour=variable))+
  geom_line() +
  geom_point( size=2, shape=21, fill="white") + 
  labs(x = '', y = 'Proporción de captura en N° a la edad',fill="",color=" grupos de edad") +
  scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
    scale_colour_discrete(name = "Grupos de edad",  labels = c('GE 0','GE 1','GE 2','GE 3','GE 4'))+
  ggtitle("CRUCERO DE OTOÑO")+
  theme_bw(base_size=11) + 
  theme(plot.title = element_text(hjust = 0.5))

f1 + f2

```

\pagebreak
```{r Fig24,warning=F, include=T, message=F, echo=F,fig.height=6,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}
pobsR    <- rep1$pobs_RECLAS        
pR       <- c(pobsR); pR[pR==0]  <-NA
pobsP    <- rep1$pobs_PELACES      
pP       <- c(pobsP); pP[pP==0]  <-NA 

years    <- rep1$years 
nyears   <- dat1$nanos
age      <- seq(0,4,1)                                            
nage     <- length(age)

anos <- rep(years,length(age)) 
edad <- gl((length(age)),length(years),label=age)   

datosPropR=data.frame(x=edad,y=anos,tamanio=pR)
datosPropP=data.frame(x=edad,y=anos,tamanio=pP )

g1 <- ggplot (datosPropR,aes(x,y)) +
     geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha = 0.7) +
     scale_size_continuous(breaks = seq(0.05,0.65,0.2),range=c(0,6))+
     labs(x = 'Edades', y = 'Años',size="Proporción") +
     ggtitle("Cruceros de Verano")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5))

g2 <- ggplot (datosPropP,aes(x,y)) + 
      geom_point(aes(size=tamanio),color = 'gray25',shape=21, fill="gray85",alpha=0.7) +
      scale_size_continuous(breaks = seq(0.05,0.65,0.2),range=c(0,6))+
      labs(x = 'Edades', y = 'Años',size="Proporción") +
      ggtitle("Cruceros de otoño")+
      theme_bw(base_size=11) + 
      theme(plot.title = element_text(hjust = 0.5))

g1 + g2

```

## 3.1. Ajuste del modelo a los datos

```{r Fig26,warning=F, include=T, message=F, echo=F,fig.height=6.7,fig.width=6.5,fig.align="center",fig.path=dir.Fig,dev=fig}

yrs   <- rep1$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvBcV   <-0.30
cvBcO   <-0.30
cvdes   <-0.01
#=================================================================================
ind_obs           <- cbind(c(rep1$reclasobs),
                           c(rep1$pelacesobs), 
                           c(rep1$desembarqueobs))
ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('Crucero_verano', 
                       'Crucero_otoño', 
                       'Desembarques') 
#-----------------------------------------------------     
ind_sept           <- cbind(c(rep1$reclaspred), 
                            c(rep1$pelacespred), 
                            c(rep1$desembarquepred)) 
colnames(ind_sept) <- c('Crucero_verano', 
                        'Crucero_otoño', 
                        'Desembarques') 
#-----------------------------------------------------
ind_marzo           <- cbind(c(rep2$reclaspred),
                             c(rep2$pelacespred), 
                             c(rep2$desembarquepred)) 
colnames(ind_marzo) <- c('Crucero_verano', 
                         'Crucero_otoño', 
                         'Desembarques') 
#-----------------------------------------------------
ind_julio           <- cbind(c(rep3$reclaspred),
                             c(rep3$pelacespred), 
                             c(rep3$desembarquepred)) 
colnames(ind_julio) <- c('Crucero_verano', 
                         'Crucero_otoño', 
                         'Desembarques') 

#=================================================================================
ind               <- data.frame(ind_obs) %>%
                                mutate(Asesoria='observado') %>%
                                mutate (yrs= yrs) %>% 
                                melt(id.var=c('yrs', 'Asesoria'))  

sept               <- data.frame(ind_sept) %>% 
                                 mutate (Asesoria='septiembre_2021') %>%
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

marzo              <- data.frame(ind_marzo) %>% 
                                 mutate (Asesoria='marzo_2021') %>% 
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

julio              <- data.frame(ind_julio) %>% 
                                 mutate (Asesoria='julio_2021') %>% 
                                 mutate (yrs= yrs)  %>% 
                                 melt(id.var=c('yrs', 'Asesoria'))

#=================================================================================
#base1 <- data.frame(rbind(ind, sept,marzo,julio))  
base1 <- data.frame(rbind(ind, sept))  
#=================================================================================

#GRÁFICOS

#=================================================================================

BcV <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Crucero_verano'), 
       aes(yrs,value/1000000)) + 
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       scale_linetype_manual(values=c("solid"))+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_verano'),
       aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_verano'),
       aes(ymin = value*exp(-1.96*cvBcO)*10^-6, ymax = value*exp(1.96*cvBcO)*10^-6), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2021, by = 5)) +
       labs(x = '', y = 'Toneladas (millones)') +
       theme_bw(base_size=9) + 
       ggtitle('Crucero de verano')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BcP <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Crucero_otoño'), 
       aes(yrs,value/1000000)) + 
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       scale_colour_manual(values=c('black'),name="Asesoría") +
       scale_linetype_manual(values=c("solid"),name="Asesoría")+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_otoño'),
       aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Crucero_otoño'),
       aes(ymin = value*exp(-1.96*cvBcV)*10^-6, ymax = value*exp(1.96*cvBcV)*10^-6), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2021, by = 5)) +
       labs(x = '', y = 'Toneladas (millones)') +
       theme_bw(base_size=9) + 
       ggtitle('Crucero de otoño')+
       theme(plot.title = element_text(hjust = 0.5))

d   <- ggplot(base1 %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value/1000)) +
       geom_line(aes(colour=Asesoria,linetype = Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       scale_linetype_manual(values=c("solid"))+
       geom_point(data = base1 %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value/1000), shape = 19, colour = 'gray30') +
       geom_errorbar(data = base1 %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvdes)*10^-3, ymax = value*exp(1.96*cvdes)*10^-3), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1985, to = 2021, by = 5)) +
       labs(x = '', y = 'Toneladas (miles)') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques') +
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BcV/BcP/d + plot_layout(guides="collect")

```
\pagebreak

```{r datos_ajustes, echo=F }

# I. INDICES DE ABUNDANCIA                                                       #
years  <- dat1$Ind[,1]                                                              
nyears <- dat1$nanos                                                                
age    <- seq(0,4,1)                    
nage   <- dat1$nedades                                                            
Amax   <- dat1$nedades        
Age    <- seq(0,4,1) 
#Observado                                                                      
obsR <- rep1$reclasobs       ;obsR[obsR<=1] <-NA                                 
obsP <- rep1$pelacesobs      ;obsP[obsP<=1] <-NA                                 
obsM <- rep1$mphobs          ;obsM[obsM<=1] <-NA                                 
obsD <- rep1$desembarqueobs                                                      
#predicho                   #stdpredicho                                        
predR <- rep1$reclaspred             
predP <- rep1$pelacespred              
predM <- rep1$mphpred                         
predD <- rep1$desembarquepred                                                    
#Residuos                                                                       
Res_reclas   <- log(obsR)-log(predR)                                             
Res_Pelaces  <- log(obsP)-log(predP)                                             
Res_MPH      <- log(obsM)-log(predM)                                             
Res_Desemb   <- log(obsD)-log(predD)     

x  <- c(years,rev(years))
x1 <- c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2 <- c(years[1]-1,years[nyears]+1) #xlim

cvreclas <- rep(0.30,nyears)
cvpela   <- rep(0.30,nyears)
cvdes    <- rep(0.01,nyears)

obsR95i <- obsR*exp(-1.96*cvreclas)
obsR95s <- obsR*exp(1.96*cvreclas)
obsP95i <- obsP*exp(-1.96*cvpela)
obsP95s <- obsP*exp(1.96*cvpela)
obsD95i <- obsD*exp(-1.96*cvdes)
obsD95s <- obsD*exp(1.96*cvdes)
```

\pagebreak

```{r Fig27, warning=F, include=T, message=F, echo=F,fig.height=7,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}
par(mfcol=c(3,3),mar=c(2,4,1,1)+0.5)

 plot(years,Res_reclas,xaxp=x1,cex.axis=0.8,ylim=c(-1.1,1.1),type="h",main="Cruceros de Verano",ylab="Residuales (escala log)",xlab="")
	#mtext("b)",side=3,line=0.25,adj=-0.15,cex=1.5)
	abline(h=0,col="darkgray")
	plot(log(predR),Res_reclas, ylim=c(-1.1,1.1),main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
	abline(h=0,col="darkgray")
	#hist(Res_reclas,xlab="Residuales",ylab="Frecuencia",main="Histograma de Residuos")
	qqnorm(Res_reclas,ylim=c(-1.1,1.1)); qqline(Res_reclas, col = 2)
	
	plot(years,Res_Pelaces,xaxp=x1,ylim=c(-1.1,1.1),cex.axis=0.8,type="h",main="Cruceros de Otoño",ylab="Residuales (escala log)",xlab="")
	#mtext("b)",side=3,line=0.25,adj=-0.15,cex=1.5)
	abline(h=0,col="darkgray")
	plot(log(predP),Res_Pelaces,ylim=c(-1.1,1.1), main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
	abline(h=0,col="darkgray")
	#hist(Res_Pelaces,xlab="Residuales",ylab="Frecuencia",main="Histograma de Residuos")
	qqnorm(Res_Pelaces,ylim=c(-1.1,1.1)); qqline(Res_Pelaces, col = 2)
	
  plot(years,Res_Desemb,xaxp=x1,cex.axis=0.8,ylim=c(-1.1,1.1),type="h",main="Desembarques",ylab="Residuales (escala log)",xlab="")
#	mtext("b)",side=3,line=0.25,adj=-0.15,cex=1.5)
	abline(h=0,col="darkgray")
	plot(log(predD),Res_Desemb, ylim=c(-1.1,1.1),main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
	abline(h=0,col="darkgray")
	#hist(Res_Desemb,xlab="Residuales",ylab="Frecuencia",main="Histograma de Residuos")
	qqnorm(Res_Desemb,ylim=c(-1.1,1.1)); qqline(Res_Desemb, col = 2)
	
```

\pagebreak

```{r Fig28,warning=F, include=T, message=F, echo=F,fig.height=7,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig}

years   <- dat1$Ind[,1] 
nyears  <- length(years)  
age     <- seq(0,4,1)                                            
nage    <- length(age)   

etcf1_obs <- data.frame(rep1$pf_obs)
etcf1_pre <- rbind(rep1$pf_pred)
etcf2_pre <- rep2$pf_pred 
etcf3_pre <- rep3$pf_pred 

 obs  <- as.data.frame(etcf1_obs) %>% 
                       mutate(year=years) %>% 
                       melt(id.vars='year') %>%
                       mutate(edad = rep(age, each=nyears)) %>%
                       mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% 
                            mutate(year=years) %>%
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>%
                            mutate(type='septiembre_2021')
 
 pred_marzo <- as.data.frame(etcf2_pre) %>% 
                              mutate(year=years) %>%
                              melt(id.vars='year') %>%
                              mutate(edad = rep(age, each=nyears)) %>% 
                              mutate(type='marzo_2021')
 
  pred_julio <- as.data.frame(etcf3_pre) %>% 
                              mutate(year=years) %>%
                              melt(id.vars='year') %>%
                              mutate(edad = rep(age, each=nyears)) %>% 
                              mutate(type='julio_2021')
  
   
  #mat  <- rbind(obs,pred_sep,pred_marzo,pred_julio)
  mat  <- rbind(obs,pred_sep)
  
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + 
          labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type,linetype =type)) +
          scale_colour_manual(values=c('black'),name="Asesoría") +
          scale_linetype_manual(values=c("solid"),name="Asesoría")+
          theme(panel.background = element_rect(fill ="gray99")) + 
          theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA") + theme(plot.title = element_text(size = 12))
  fig1
  
  
```
\pagebreak

```{r Fig29,warning=F, include=T, message=F, echo=F,fig.height=7,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig}

years   <- dat1$Ind[,1] 
nyears  <- length(years)  
age     <- seq(0,4,1)                                            
nage    <- length(age)   

etcf1_obs <- data.frame(rep1$pobs_RECLAS)
etcf1_pre <- rbind(rep1$ppred_RECLAS) 
etcf2_pre <- rep2$ppred_RECLAS
etcf3_pre <- rep3$ppred_RECLAS

 obs  <- as.data.frame(etcf1_obs) %>% 
                        mutate(year=years) %>% 
                        melt(id.vars='year') %>%
                        mutate(edad = rep(age, each=nyears)) %>%
                        mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>%
                            mutate(year=years) %>% 
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>%
                            mutate(type='septiembre_2021')
 
 pred_marzo <- as.data.frame(etcf2_pre) %>%
                            mutate(year=years) %>% 
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>% 
                            mutate(type='marzo_2021')
 
 pred_julio <- as.data.frame(etcf3_pre) %>%
                            mutate(year=years) %>% 
                            melt(id.vars='year') %>%
                            mutate(edad = rep(age, each=nyears)) %>% 
                            mutate(type='julio_2021')
  
 
  #mat  <- rbind(obs,pred_sep,pred_marzo,pred_julio)
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type,linetype =type)) +
          scale_colour_manual(values=c('black'),name="Asesoría") +
          scale_linetype_manual(values=c("solid"),name="Asesoría")+
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("CRUCEROS DE VERANO") + theme(plot.title = element_text(size = 12))
  fig1
  
```

\pagebreak

```{r Fig30,warning=F, include=T, message=F, echo=F,fig.height=7,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig}

years   <- dat1$Ind[,1] 
nyears  <- length(years)  
age     <- seq(0,4,1)                                            
nage    <- length(age)   

etcf1_obs <- data.frame(rep1$pobs_PELACES)
etcf1_pre <- rbind(rep1$ppred_PELACES) 
etcf2_pre <- rep2$ppred_PELACES
etcf3_pre <- rep3$ppred_PELACES

 obs  <- as.data.frame(etcf1_obs) %>% 
                        mutate(year=years) %>% 
                        melt(id.vars='year') %>%
                        mutate(edad = rep(age, each=nyears)) %>%
                        mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% 
                        mutate(year=years) %>% 
                        melt(id.vars='year') %>%
                        mutate(edad = rep(age, each=nyears)) %>% 
                        mutate(type='septiembre_2021')
 
 pred_marzo <- as.data.frame(etcf2_pre) %>% 
                          mutate(year=years) %>% 
                          melt(id.vars='year') %>%
                          mutate(edad = rep(age, each=nyears)) %>% 
                          mutate(type='marzo_2021')
 
  pred_julio <- as.data.frame(etcf3_pre) %>% 
                          mutate(year=years) %>% 
                          melt(id.vars='year') %>%
                          mutate(edad = rep(age, each=nyears)) %>% 
                          mutate(type='julio_2021')
  
  #mat  <- rbind(obs,pred_sep,pred_marzo,pred_julio)
  mat  <- rbind(obs,pred_sep)
  
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporción') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type,linetype =type)) +
          scale_colour_manual(values=c('black'),name="Asesoría") +
          scale_linetype_manual(values=c("solid"),name="Asesoría")+
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("CRUCEROS DE OTOÑO") + theme(plot.title = element_text(size = 12))
  fig1
  
```

\pagebreak

```{r Fig31, echo=F, warning=F, include=T, message=F,fig.height=5,fig.width=10,fig.align="center",fig.path=dir.Fig,dev=fig}

ppredF<-rep1$pf_pred                                          
ppredR<-rep1$ppred_RECLAS                                     
ppredP<-rep1$ppred_PELACES

#DESEMBARQUES
anos <-dat1$Ind[,1] 
obsF <-pobsF
preF <-ppredF  
resF <-obsF-preF

rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,3),mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}

mtext("Flota",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1.1)
	mtext("a)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

# RECLAS
anos<-years[11:nyears]
obsR <-pobsR[11:nyears,]
preR <-ppredR[11:nyears,]
resR <-obsR-preR

rng <-range(resR,na.rm=T)
dd  <-dim(resR)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resR[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

#par(mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}
mtext("Crucero de verano",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1.1)
mtext("b)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

# PELACES
anos<-years[17:nyears]
obsP <-pobsP[17:nyears,]
preP <-ppredP[17:nyears,]  
resP <-obsP-preP

rng <-range(resP,na.rm=T)
dd  <-dim(resP)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resP[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

#par(mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}
mtext("Crucero de otoño",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("Años",side=2,line=4.7,cex=1.1)
mtext("c)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

```



## 3.2. Comparación con asesorías previas

```{r VariablesSept_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep1$years
nyears<-length(years)

Rt1      <- subset(std1,name=="Reclutas")$value 
Rt1std   <- subset(std1,name=="Reclutas")$std
BT1      <- subset(std1,name=="BT")$value   
BT1std   <- subset(std1,name=="BT")$std
BD1      <- subset(std1,name=="SSB")$value   
BD1std   <- subset(std1,name=="SSB")$std
Ft1      <- subset(std1,name=="log_Ft")$value   
Ft1std   <- subset(std1,name=="log_Ft")$std

VarPob<- data.frame(x=years,
                    Rt1=Rt1,
                    BT1=BT1,
                    BD1=BD1,
                    Ft1=exp(Ft1), 
         lowerRt1 = (Rt1 -1.96*Rt1std),
         upperRt1 = (Rt1 +1.96*Rt1std),
         lowerBT1 = (BT1 -1.96*BT1std),
         upperBT1 = (BT1 +1.96*BT1std),
         lowerBD1 = (BD1 -1.96*BD1std), 
         upperBD1 = (BD1 +1.96*BD1std),
         lowerFt1 = exp(Ft1 -1.96*Ft1std), 
         upperFt1 = exp(Ft1 +1.96*Ft1std))

```



```{r Fig32_data, eval=T, warning=F, include=T, message=F, echo=F,fig.height=7,fig.width=4,fig.align="center",fig.path=dir.Fig,dev=fig}

dir<-paste(dir.0,"/rep_AsesoriasPrevias",sep="")
setwd(dir)

sept18 <-paste(dir,"/MAE0918.rep",sep="")
mar19  <-paste(dir,"/MAE0319.rep",sep="")
jul19  <-paste(dir,"/MAE0719.rep",sep="")
sept19 <-paste(dir,"/MAE0919.rep",sep="")
mar20  <-paste(dir,"/MAE0320.rep",sep="")
jul20  <-paste(dir,"/MAE0720.rep",sep="")
sept20 <-paste(dir,"/MAE0920.rep",sep="")
mar21  <-paste(dir.1,"/MAE0321.rep",sep="")
jul21  <-paste(dir.1,"/MAE0721.rep",sep="")
sept21 <-paste(dir.1,"/MAE0921.rep",sep="")
#================================================================================#
rep_sept18 <- reptoRlist(sept18)
rep_mar19  <- reptoRlist(mar19)
rep_jul19  <- reptoRlist(jul19)
rep_sept19 <- reptoRlist(sept19)
rep_mar20 <- reptoRlist(mar20)
rep_jul20 <- reptoRlist(jul20)
rep_sept20 <- reptoRlist(sept20)
rep_mar21  <- reptoRlist(mar21)
rep_jul21  <- reptoRlist(jul21)
rep_sept21 <- reptoRlist(sept21)
#================================================================================#
years  <- rep_sept21$years
nyears <- length(years)                                                                
x  <-c(years,rev(years))
x1 <-c(years[1],years[nyears]+1,nyears+1/2) #xaxp
x2 <-c(years[1]-1,years[nyears]+1) #xlim

 Rtcomp <- data.frame(x=years,
                          Rt_sept18=c(rep_sept18$Reclutas,NA,NA,NA),
                          Rt_mar19=c(rep_mar19$Reclutas,NA,NA),
                          Rt_jul19=c(rep_jul19$Reclutas,NA,NA),
                          Rt_sept19=c(rep_sept19$Reclutas,NA,NA),
                          Rt_mar20=c(rep_mar20$Reclutas,NA),
                          Rt_jul20=c(rep_jul20$Reclutas,NA),
                          Rt_sept20=c(rep_sept20$Reclutas,NA),
                          Rt_mar21=c(rep_mar21$Reclutas),
                          Rt_jul21=c(rep_jul21$Reclutas),
                          Rt_sept21=c(rep_sept21$Reclutas))
 
 SSBtcomp <- data.frame(x=years,
                          SSBt_sept18=c(rep_sept18$SSB,NA,NA,NA),
                          SSBt_mar19=c(rep_mar19$SSB,NA,NA),
                          SSBt_jul19=c(rep_jul19$SSB,NA,NA),
                          SSBt_sept19=c(rep_sept19$SSB,NA,NA),
                          SSBt_mar20=c(rep_mar20$SSB,NA),
                          SSBt_jul20=c(rep_jul20$SSB,NA),
                          SSBt_sept20=c(rep_sept20$SSB,NA),
                          SSBt_mar21=c(rep_mar21$SSB),
                          SSBt_jul21=c(rep_jul21$SSB),
                          SSBt_sept21=c(rep_sept21$SSB))
 
 Ftcomp <- data.frame(x=years,
                          Ft_sept18=c(rep_sept18$Ftot,NA,NA,NA),
                          Ft_mar19=c(rep_mar19$Ftot,NA,NA),
                          Ft_jul19=c(rep_jul19$Ftot,NA,NA),
                          Ft_sept19=c(rep_sept19$Ftot,NA,NA),
                          Ft_mar20=c(rep_mar20$Ftot,NA),
                          Ft_jul20=c(rep_jul20$Ftot,NA),
                          Ft_sept20=c(rep_sept20$Ftot,NA),
                          Ft_mar21=c(rep_mar21$Ftot),
                          Ft_jul21=c(rep_jul21$Ftot),
                          Ft_sept21=c(rep_sept21$Ftot))
  
```



```{r Fig32, echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=7, fig.width=7,fig.path=dir.Fig,dev=fig}

year_retros <- c('2021_sept',"2021_julio","2021_marzo","2020_sept","2020_julio","2020_marzo")
nretros <-6


#Retrospectivo tradicional
Rt <- ggplot(Rtcomp) + 
    geom_ribbon(data=VarPob,aes(ymin=lowerRt1, ymax=upperRt1, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=Rt_mar20, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=Rt_jul20, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=Rt_sept20, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=Rt_mar21, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=Rt_jul21, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_line(aes(y=Rt_sept21, x=x, colour = year_retros[nretros-5]), size=0.5)+
    labs(x = '', y = 'Reclutamientos ',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
    scale_colour_manual("",values=c("gray","orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=11) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(SSBtcomp) + 
     geom_ribbon(data=VarPob,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=SSBt_mar20, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=SSBt_jul20, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=SSBt_sept20, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=SSBt_mar21, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=SSBt_jul21, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_line(aes(y=SSBt_sept21, x=x, colour = year_retros[nretros-5]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
    scale_colour_manual("",values=c("gray","orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=11) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5))

Ft <- ggplot(Ftcomp) + 
    geom_ribbon(data=VarPob,aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = "IC"), alpha = 0.2)+
    geom_line(aes(y=Ft_mar20, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=Ft_jul20, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=Ft_sept20, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=Ft_mar21, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=Ft_jul21, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_line(aes(y=Ft_sept21, x=x, colour = year_retros[nretros-5]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
    scale_colour_manual("",values=c("gray","orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=11) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft 


```


## 3.3. Análisis retrospectivo

```{r Dat_RetrospectivoJulio, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/Retrospectivo_sept",sep="")
setwd(dir)
admb<-"MAE0921"

years       <-rep1$years
nyears      <-length(years)
retros      <-seq(1,5)
nretros     <-length(retros)
year_retros <-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1]  <- c(rep$Reclutas,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$SSB,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$Ftot,rep(NA,i-1)) }


# retrospectivo relativo (cálculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j]   <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]        <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, 
                      y1=retroR[,2],
                      y2=retroR[,3],
                      y3=retroR[,4],
                      y4=retroR[,5],
                      y5=retroR[,6],
                      lower = (Rt1 -1.96*Rt1std), 
                      upper = (Rt1 +1.96*Rt1std))
BD_retro<- data.frame(x=years, 
                      y1=retroBD[,2],
                      y2=retroBD[,3],
                      y3=retroBD[,4],
                      y4=retroBD[,5],
                      y5=retroBD[,6],
                      lower = (BD1 -1.96*BD1std), 
                      upper = (BD1 +1.96*BD1std))
Ft_retro<- data.frame(x=years, 
                      y1=retroF[,2],
                      y2=retroF[,3],
                      y3=retroF[,4],
                      y4=retroF[,5],
                      y5=retroF[,6], 
                      lower = exp(Ft1 -1.96*Ft1std), 
                      upper = exp(Ft1 +1.96*Ft1std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, 
                         y1=rel.diff.r[,1],
                         y2=rel.diff.r[,2],
                         y3=rel.diff.r[,3],
                         y4=rel.diff.r[,4],
                         y5=rel.diff.r[,5])
BD_retroRel<- data.frame(x=years, 
                         y1=rel.diff.ssb[,1],
                         y2=rel.diff.ssb[,2],
                         y3=rel.diff.ssb[,3],
                         y4=rel.diff.ssb[,4],
                         y5=rel.diff.ssb[,5])
Ft_retroRel<- data.frame(x=years, 
                         y1=rel.diff.f[,1],
                         y2=rel.diff.f[,2],
                         y3=rel.diff.f[,3],
                         y4=rel.diff.f[,4],
                         y5=rel.diff.f[,5])

```



```{r Fig33, echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=10, fig.width=10,fig.path=dir.Fig,dev=fig}

#Retrospectivo tradicional
Rt <- ggplot(Rt_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "IC asintótico"), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Reclutamientos ',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2000, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2000, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2000, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=12) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```



## 3.4. Perfil de verosimilitud


```{r Fig34,eval=T, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig}

dir<-paste(dir.0,"/Verosimilitud_sept",sep="")
setwd(dir)

casos <-23
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=15,nrow=casos)
slikeval <- matrix(ncol=16,nrow=casos)

for(i in 1:casos){
report      <- reptoRlist(paste(dir,"/MAE0921s",i,".rep",sep=""))
logRo[i]    <- report$log_Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)                         # busca el mínimo
for(i in 1:16){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarización

names<-c("Ro","Reclas","Pelaces","Desembarques","MPDH","propF",
	"propRecl","propPel","prepPelTall","DesvRt","qreclas","qpela","PenFt",
	"PenFspr","NA","NA","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2 <- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names

par(mar=c(4,4,1,1))
plot(TLk2$Ro,TLk2$Total,type="l",lwd=3,ylim=c(0,3),xlim=c(10^4,32*10^4),
	xaxs= "i",	ylab="L-min(L)",xlab="Ro",las=1,main='Asesoría Septiembre 2021',cex.main=0.8,cex.axis=0.8,cex.lab=0.8)
lines(c(0,TLk2$Ro),rep(2,casos+1),lty=2,lwd=2)
for(i in 2:8){lines(TLk2$Ro,TLk2[,i],col=i,lty=2,lwd=2)}
#for(i in 9:14){lines(TLk2$Ro,TLk2[,i],col=i,lty=3,lwd=2)}
legend(210000,2.9,names[c(17,2:8)],col=1:8,lty=c(1,rep(2,7)),lwd=2,bty="n",cex=0.75)
#legend(230000,1.5,names[9:14],col=9:14,lty=3,lwd=2,bty="n",cex=0.8)

```



## 3.5. Variables poblacionales

```{r Variables_sept, echo=F,message=FALSE, warning=FALSE, include=T}

years1<-rep1$years
nyears1<-length(years1)

Rt1      <- c(subset(std1,name=="Reclutas")$value) 
Rt1std   <- c(subset(std1,name=="Reclutas")$std)
BT1      <- c(subset(std1,name=="BT")$value)   
BT1std   <- c(subset(std1,name=="BT")$std)
BD1      <- c(subset(std1,name=="SSB")$value)   
BD1std   <- c(subset(std1,name=="SSB")$std)
Ft1      <- c(subset(std1,name=="log_Ft")$value)   
Ft1std   <- c(subset(std1,name=="log_Ft")$std)

VarPobSep<- data.frame(x=years1,
                       Rt1=Rt1,
                       BT1=BT1,
                       BD1=BD1,
                       Ft1=exp(Ft1), 
         lowerRt1 = (Rt1 -1.96*Rt1std), upperRt1 = (Rt1+1.96*Rt1std),
         lowerBT1 = (BT1 -1.96*BT1std), upperBT1 = (BT1+1.96*BT1std),
         lowerBD1 = (BD1 -1.96*BD1std), upperBD1 = (BD1+1.96*BD1std),
         lowerFt1 = exp(Ft1 -1.96*Ft1std), upperFt1 = exp(Ft1+1.96*Ft1std))
```



```{r Variables_marzo, echo=F,message=FALSE, warning=FALSE, include=T}

years2<-rep2$years
nyears2<-length(years2)

Rt2      <- subset(std2,name=="Reclutas")$value 
Rt2std   <- subset(std2,name=="Reclutas")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="SSB")$value   
BD2std   <- subset(std2,name=="SSB")$std
Ft2      <- subset(std2,name=="log_Ft")$value   
Ft2std   <- subset(std2,name=="log_Ft")$std

VarPobMar<- data.frame(x=years2, 
                       Rt2=Rt2,
                       BT2=BT2,
                       BD2=BD2,
                       Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std), 
         upperRt2 = (Rt2+1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std), 
         upperBT2 = (BT2+1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), 
         upperBD2 = (BD2+1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), 
         upperFt2 = exp(Ft2+1.96*Ft2std))
```


```{r Variables_julio, echo=F,message=FALSE, warning=FALSE, include=T}

years3   <- rep3$years
nyears3  <- length(years3)

Rt3      <- subset(std3,name=="Reclutas")$value 
Rt3std   <- subset(std3,name=="Reclutas")$std
BT3      <- subset(std3,name=="BT")$value   
BT3std   <- subset(std3,name=="BT")$std
BD3      <- subset(std3,name=="SSB")$value   
BD3std   <- subset(std3,name=="SSB")$std
Ft3      <- subset(std3,name=="log_Ft")$value   
Ft3std   <- subset(std3,name=="log_Ft")$std

VarPobJul<- data.frame(x=years3, 
                       Rt3=Rt3,
                       BT3=BT3,
                       BD3=BD3,
                       Ft3=exp(Ft3), 
         lowerRt3 = (Rt3 -1.96*Rt3std), 
         upperRt3 = (Rt3 +1.96*Rt3std),
         lowerBT3 = (BT3 -1.96*BT3std), 
         upperBT3 = (BT3 +1.96*BT3std),
         lowerBD3 = (BD3 -1.96*BD3std), 
         upperBD3 = (BD3 +1.96*BD3std),
         lowerFt3 = exp(Ft3 -1.96*Ft3std), 
         upperFt3 = exp(Ft3 +1.96*Ft3std))
```



```{r Fig35, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=6, fig.width=8,fig.path=dir.Fig,dev=fig}


Rt <- ggplot() + 
    #geom_line(data=VarPobJul,aes(y=Rt3, x=x, colour = "julio 2021"),linetype="solid", size=0.5)+
    #geom_line(data=VarPobMar,aes(y=Rt2, x=x, colour = "marzo 2021"),linetype="dashed",size=0.5)+
    geom_line(data=VarPobSep,aes(y=Rt1, x=x, colour = "septiembre 2021"),linetype="solid", size=0.5)+
    #geom_ribbon(data=VarPobJul,aes(ymin=lowerRt3, ymax=upperRt3, x=x, fill = "IC_julio2021"), alpha = 0.2)+
   # geom_ribbon(data=VarPobMar,aes(ymin=lowerRt2, ymax=upperRt2, x=x, fill = ""), alpha = 0.2)+
    geom_ribbon(data=VarPobSep,aes(ymin=lowerRt1, ymax=upperRt1, x=x, fill = "IC"), alpha = 0.2)+
    geom_hline(yintercept = mean(VarPobSep$Rt1),colour='black',lty=2) +
     annotate("text", x=2000, y=mean(VarPobSep$Rt1)*1.3,label=expression("R"[promedio])) +
    labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
    scale_colour_manual("",values=c("black"))+
     scale_linetype_manual(values=c("solid"))+
    scale_fill_manual("",values=c('gray60'))+
    theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top",legend.text = element_text(size=5))

BT <- ggplot() + 
     #geom_line(data=VarPobJul,aes(y=BT3, x=x, colour = "julio 2021"),linetype="solid", size=0.5)+
     #geom_line(data=VarPobMar,aes(y=BT2, x=x, colour = "marzo 2021"),linetype="dashed", size=0.5)+
     geom_line(data=VarPobSep,aes(y=BT1, x=x, colour = "septiembre 2021"),linetype="solid", size=0.5)+
     #geom_ribbon(data=VarPobJul,aes(ymin=lowerBT3, ymax=upperBT3, x=x, fill = ""), alpha = 0.2)+
     #geom_ribbon(data=VarPobMar,aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = ""), alpha = 0.2)+
     geom_ribbon(data=VarPobSep,aes(ymin=lowerBT1, ymax=upperBT1, x=x, fill = ""), alpha = 0.2)+
   geom_hline(data=VarPobSep,yintercept = mean(BT1),colour='black',lty=2) +
     annotate("text", x=2000, y=mean(BT1)*1.2,label=expression("BT"[promedio])) +
    labs(x = '', y = 'Biomasa total (t)',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
    scale_colour_manual("",values=c("black"))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot() + 
     #geom_line(data=VarPobJul,aes(y=BD3, x=x, colour = "julio 2021"),linetype="solid", size=0.5)+
     #geom_line(data=VarPobMar,aes(y=BD2, x=x, colour = "marzo 2021"),linetype="dashed", size=0.5)+
     geom_line(data=VarPobSep,aes(y=BD1, x=x, colour = "septiembre 2021"),linetype="solid", size=0.5)+
     #geom_ribbon(data=VarPobJul,aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "IC_julio2021"), alpha = 0.2)+
     #geom_ribbon(data=VarPobMar,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = ""), alpha = 0.2)+
     geom_ribbon(data=VarPobSep,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = ""), alpha = 0.2)+
     geom_hline(data=VarPobSep,yintercept = mean(BD1),colour='black',lty=2) +
     annotate("text", x=2000, y=mean(BD1)*1.3,label=expression("BD"[promedio])) +
     labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
     scale_colour_manual("",values=c("black"))+
      scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top",legend.text = element_text(size=7))

Ft <- ggplot() + 
    #geom_line(data=VarPobJul,aes(y=Ft3, x=x, colour = "julio 2021"),linetype="solid", size=0.5)+
    #geom_line(data=VarPobMar,aes(y=Ft2, x=x, colour = "marzo 2021"),linetype="dashed", size=0.5)+
    geom_line(data=VarPobSep,aes(y=Ft1, x=x, colour = "septiembre 2021"),linetype="solid", size=0.5)+
    #geom_ribbon(data=VarPobJul,aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
    #geom_ribbon(data=VarPobMar,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
    geom_ribbon(data=VarPobSep,aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = ""), alpha = 0.2)+
     geom_hline(yintercept = median(VarPobSep$Ft1),colour='black',lty=2) +
     annotate("text", x=2018, y=median(VarPobSep$Ft1)*1.3,label=expression("F"[mediana])) +
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1990, to = 2022, by = 4)) +
    scale_colour_manual("",values=c("black"))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT | (BD/Ft)

```

\pagebreak
\footnotesize

```{r Tabla_20, echo=F,warning=FALSE,include=T}
yearsb<-c("1990/91","1991/92","1992/93","1993/94","1994/95","1995/96","1996/97","1997/98","1998/99","1999/00","2000/01","2001/02","2002/03","2003/04","2004/05","2005/06","2006/07","2007/08","2008/09","2009/10","2010/11","2011/12","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18","2018/19","2019/20",'2020/21')

Rt1      <- c(subset(std1,name=="Reclutas")$value) 
Rt1std   <- c(subset(std1,name=="Reclutas")$std)
BT1      <- c(subset(std1,name=="BT")$value)   
BT1std   <- c(subset(std1,name=="BT")$std)
BD1      <- c(subset(std1,name=="SSB")$value)   
BD1std   <- c(subset(std1,name=="SSB")$std)
Ft1      <- c(subset(std1,name=="log_Ft")$value)   
Ft1std   <- c(subset(std1,name=="log_Ft")$std)


Rt2      <- subset(std2,name=="Reclutas")$value 
Rt2std   <- subset(std2,name=="Reclutas")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="SSB")$value   
BD2std   <- subset(std2,name=="SSB")$std
Ft2      <- subset(std2,name=="log_Ft")$value   
Ft2std   <- subset(std2,name=="log_Ft")$std


Rt3      <- rep3$Reclutas
Rt3std   <- subset(std3,name=="Reclutas")$std
BT3      <- rep3$BT 
BT3std   <- subset(std3,name=="BT")$std
BD3      <- rep3$SSB  
BD3std   <- subset(std3,name=="SSB")$std
Ft3      <- log(rep3$Ftot) 
Ft3std   <- subset(std3,name=="log_Ft")$std


VarPobl1<- cbind('Año'=yearsb,
                 "$BD_{sept}$"=c(BD1),
                 "$BD_{marzo}$"=c(BD2),
                 "$BD_{julio}$"=c(BD3),
                 "$BT_{sept}$"=c(BT1),
                 "$BT_{marzo}$"=c(BT2),
                 "$BT_{julio}$"=c(BT3),
                 "$R_{sept}$"=c(Rt1),
                 "$R_{marzo}$"=c(Rt2),
                 "$R_{julio}$"=c(Rt3),
                 "$F_{sept}$"=c(round(exp(Ft1),3)),
                 "$F_{marzo}$"=c(round(exp(Ft2),3)),
                 "$F_{julio}$"=c(round(exp(Ft3),3)))
kable(VarPobl1)

#setwd(dir.basedatos)
write.csv(VarPobl1, file="Tablas/Tabla_20_indicadorespoblacionales.csv")
#setwd(dir.1)
```




```{r Tabla_20_promedios, echo=F,warning=FALSE,include=T,eval=T}

# Reclutimientos asesoría marzo 2021
Rprom_1991_2007<-mean(Rt1[1:17])
Rprom_2008_2012<-mean(Rt1[18:22])
Rprom_2013_2021<-mean(Rt1[23:31])
Rprom_2013_2020<-mean(Rt1[23:30])
Rprom_historico<-mean(Rt1)

Rprom<-rbind(Rprom_1991_2007,
      Rprom_2008_2012,
      Rprom_2013_2021,
      Rprom_2013_2020,
      Rprom_historico)

#diferencia del Rúltimo año y los promedios de los tres períodos principales
Rlast_1991_2007<-1-(Rt1[31]/Rprom_1991_2007)
Rlast_2008_2012<-1-(Rt1[31]/Rprom_2008_2012)
Rlast_2013_2021<-1-(Rt1[31]/Rprom_2013_2021)
Rlast_2013_2020<-1-(Rt1[31]/Rprom_2013_2020)
Rlast_historico<-1-(Rt1[31]/Rprom_historico)

difR<-rbind(Rlast_1991_2007,
      Rlast_2008_2012,
      Rlast_2013_2021,
      Rlast_2013_2020,
      Rlast_historico)

# Biomasa total (BT) asesoría marzo 2021
BTprom_1991_2007<-mean(BT1[1:17])
BTprom_2008_2012<-mean(BT1[18:22])
BTprom_2013_2021<-mean(BT1[23:31])
BTprom_2013_2020<-mean(BT1[23:30])
BTprom_historico<-mean(BT1)

BTprom<-rbind(BTprom_1991_2007,
      BTprom_2008_2012,
      BTprom_2013_2021,
      BTprom_2013_2020,
      BTprom_historico)

#diferencia del BT último año y los promedios de los tres períodos principales
BTlast_1991_2007<-1-(BT1[31]/BTprom_1991_2007)
BTlast_2008_2012<-1-(BT1[31]/BTprom_2008_2012)
BTlast_2013_2021<-1-(BT1[31]/BTprom_2013_2021)
BTlast_2013_2020<-1-(BT1[31]/BTprom_2013_2020)
BTlast_historico<-1-(BT1[31]/BTprom_historico)

difBT<- rbind(BTlast_1991_2007,
      BTlast_2008_2012,
      BTlast_2013_2021,
      BTlast_2013_2020,
      BTlast_historico)


# Biomasa desovante (BD) asesoría marzo 2021

BDprom_1991_2007<-mean(BD1[1:17])
BDprom_2008_2012<-mean(BD1[18:22])
BDprom_2013_2021<-mean(BD1[23:31])
BDprom_2013_2020<-mean(BD1[23:30])
BDprom_historico<-mean(BD1)
  
BDprom<-rbind(BDprom_1991_2007,
      BDprom_2008_2012,
      BDprom_2013_2021,
      BDprom_2013_2020,
      BDprom_historico)

#diferencia del BD último año y los promedios de los tres períodos principales
BDlast_1991_2007<-1-(BD1[31]/BDprom_1991_2007)
BDlast_2008_2012<-1-(BD1[31]/BDprom_2008_2012)
BDlast_2013_2021<-1-(BD1[31]/BDprom_2013_2021)
BDlast_2013_2020<-1-(BD1[31]/BDprom_2013_2020)
BDlast_historico<-1-(BD1[31]/BDprom_historico)

difBD<-rbind(BDlast_1991_2007,
      BDlast_2008_2012,
      BDlast_2013_2021,
      BDlast_2013_2020,
      BDlast_historico)


diferencias<-cbind(difR,difBT,difBD,Rprom,BTprom,BDprom)
colnames(diferencias)<-c("difRt","difBT","difBD","Rprom","BTprom","BDprom")
diferencias

write.csv(diferencias, file="Tablas/Tabla_20_diferencias.csv")


```




```{r Fig36,warning=F, include=T, message=F, echo=F,fig.height=3.5,fig.width=3.5,fig.align="center",fig.path=dir.Fig,dev=fig}

sel_Flota<-rep1$Sel_flota[1,]
sel_CruV <-rep1$Sel_reclas[1,]
sel_CruO <-rep1$Sel_pelaces[1,]

g1 <- ggplot () +
     #lineas
     geom_line(aes(x=age,y=sel_Flota))+
     geom_line(aes(x=age,y=sel_CruV))+
     geom_line(aes(x=age,y=sel_CruO),linetype="dashed")+
     #puntos
     geom_point(aes(x=age,y=sel_Flota,shape="FLota"),size=2.5) +
     geom_point(aes(x=age,y=sel_CruV,shape="Cruceros de Verano"),size=2.5) +
     geom_point(aes(x=age,y=sel_CruO,shape="Cruceros de Otoño"),size=2.5) +
     #parámetros
     labs(x = 'Edad (años)', y = 'Patrón de explotación',shape="Selectividades") +
     ggtitle("")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.justification=c(1.1,0), legend.position=c(1,0.1))
g1

```

\pagebreak

## 3.6. Puntos biológicos de referencia

```{r Data_PBR_biologico_sept, echo=F}
#PBR año biologico
Amax        <- dat1$nedades 
Fmort 	    <- seq(0,3.5,0.02)           
nf          <- length(Fmort) 
R0 		      <- 1  
#datos de entrada 
Dat<-list()
Dat$M		    <- dat1$par[5]             
Dat$Tspw	  <- dat1$Dt[3]              
Dat$Mad	    <- dat1$madurezsexual        
Dat$Wmed	  <- colMeans(dat1$Wmed)      
Dat$Wini	  <- colMeans(dat1$Wini) 
Dat$Sel     <- rep1$Sel_flota[1,] 

Rmed1        <- mean(Rt1,na.rm = T)           
Bmed1        <- mean(BD1,na.rm = T)         
Fmedian1     <- exp(median(Ft1,na.rm = T))

Bobj        <-c(.85,.80,.60,.55,.52,.50,.45,.40,.30,.325,0.425)
Fobj      	<- optim(par=rep(0.,11),fn=SPRFpbr,method='BFGS')

SPR1 		    <- SPRFmort(Rmed1,c(0,Fobj$par,Fmedian1,rep1$Ftot[25]),Amax,Dat) 
pSPR_Fmh1    <- as.numeric(SPR1[13,4])                     # Paso 2: Cálculo de la curva SPR
pB_Fmh1      <- pSPR_Fmh1-0.05                             # Paso 3: Aproximación obtención de %BD(Fmh)
SPRcurv1 		<- SPRFmort(R0,Fmort,Amax,Dat) 
```




```{r Data_PBR_biologico_marzo, echo=F}
#PBR año biologico
Amax        <- dat2$nedades 
Fmort 	    <- seq(0,3.5,0.02)           
nf          <- length(Fmort) 
R0 		      <- 1  
#datos de entrada 
Dat<-list()
Dat$M		    <- dat2$par[5]             
Dat$Tspw	  <- dat2$Dt[3]              
Dat$Mad	    <- dat2$madurezsexual        
Dat$Wmed	  <- colMeans(dat2$Wmed)      
Dat$Wini	  <- colMeans(dat2$Wini) 
Dat$Sel     <- rep2$Sel_flota[1,] 

Rmed2        <- mean(Rt2)           
Bmed2        <- mean(BD2)         
Fmedian2     <- exp(median(Ft2))

Bobj        <-c(.85,.80,.60,.55,.52,.50,.45,.40,.30,.325,0.425)
Fobj      	<- optim(par=rep(0.,11),fn=SPRFpbr,method='BFGS')

SPR2 		    <- SPRFmort(Rmed2,c(0,Fobj$par,Fmedian2,rep2$Ftot[25]),Amax,Dat) 
pSPR_Fmh2    <- as.numeric(SPR2[13,4])                     # Paso 2: Cálculo de la curva SPR
pB_Fmh2      <- pSPR_Fmh2-0.05                             # Paso 3: Aproximación obtención de %BD(Fmh)
SPRcurv2 		<- SPRFmort(R0,Fmort,Amax,Dat) 
```




```{r Data_PBR_biologico_julio, echo=F}
#PBR año biologico
Amax        <- dat3$nedades 
Fmort 	    <- seq(0,3.5,0.02)           
nf          <- length(Fmort) 
R0 		      <- 1  
#datos de entrada 
Dat<-list()
Dat$M		    <- dat3$par[5]             
Dat$Tspw	  <- dat3$Dt[3]              
Dat$Mad	    <- dat3$madurezsexual        
Dat$Wmed	  <- colMeans(dat3$Wmed)      
Dat$Wini	  <- colMeans(dat3$Wini) 
Dat$Sel     <- rep3$Sel_flota[1,] 

Rmed3        <- mean(Rt3)           
Bmed3        <- mean(BD3)         
Fmedian3     <- exp(median(Ft3))

Bobj        <-c(.85,.80,.60,.55,.52,.50,.45,.40,.30,.325,0.425)
Fobj      	<- optim(par=rep(0.,11),fn=SPRFpbr,method='BFGS')

SPR3 		    <- SPRFmort(Rmed3,c(0,Fobj$par,Fmedian3,rep3$Ftot[25]),Amax,Dat) 
pSPR_Fmh3    <- as.numeric(SPR3[13,4])                     # Paso 2: Cálculo de la curva SPR
pB_Fmh3      <- pSPR_Fmh3-0.05                             # Paso 3: Aproximación obtención de %BD(Fmh)
SPRcurv3 		<- SPRFmort(R0,Fmort,Amax,Dat) 
```


```{r pbrs septiembre, echo=F}
# ASESORÍA DE SEPTIEMBRE
Bo1           <- rep1$SSBpbr[1]                         # Paso 4: Obtenci?n de Bo
BRMS1         <- rep1$SSBpbr[3]                         # Paso 5: Obtenci?n de Brms = 60%SPRo = 55%Bo
FRMS1         <- rep1$Fs[2]
BLIM1         <- Bo1*0.275                              # Paso 6: Obtenci?n de Blim = 20%Bo 
FLIM1         <- rep1$Fs[3]                             # Paso 6: Obtenci?n de Flim = 30%SPRo
SpB1          <- BD1                                  # BD serie hist?rica de evaluaci?n de stock 
SpBSE1        <- BD1std                               # desviaci?n estandar BD
ln_Fyr1       <- Ft1                                    # logaritmo de Ft
ln_FSE1       <- Ft1std                                 # logaritmo de la desviaci?n standar de Ft
```




```{r pbrs marzo, echo=F}
# ASESORÍA DE SEPTIEMBRE
Bo2           <- rep2$SSBpbr[1]                         # Paso 4: Obtenci?n de Bo
BRMS2         <- rep2$SSBpbr[3]                         # Paso 5: Obtenci?n de Brms = 60%SPRo = 55%Bo
FRMS2         <- rep2$Fs[2]
BLIM2         <- Bo2*0.275                              # Paso 6: Obtenci?n de Blim = 20%Bo 
FLIM2         <- rep2$Fs[3]                             # Paso 6: Obtenci?n de Flim = 30%SPRo
SpB2          <- BD2                                  # BD serie hist?rica de evaluaci?n de stock 
SpBSE2        <- BD2std                               # desviaci?n estandar BD
ln_Fyr2       <- Ft2                                    # logaritmo de Ft
ln_FSE2       <- Ft2std                                 # logaritmo de la desviaci?n standar de Ft
```

\pagebreak


```{r pbrs julio, echo=F}
# ASESORÍA DE SEPTIEMBRE
Bo3           <- rep3$SSBpbr[1]                         # Paso 4: Obtenci?n de Bo
BRMS3         <- rep3$SSBpbr[3]                         # Paso 5: Obtenci?n de Brms = 60%SPRo = 55%Bo
FRMS3         <- rep3$Fs[2]
BLIM3         <- Bo3*0.275                              # Paso 6: Obtenci?n de Blim = 20%Bo 
FLIM3         <- rep3$Fs[3]                             # Paso 6: Obtenci?n de Flim = 30%SPRo
SpB3          <- BD3                                  # BD serie hist?rica de evaluaci?n de stock 
SpBSE3        <- BD3std                               # desviaci?n estandar BD
ln_Fyr3       <- Ft3                                    # logaritmo de Ft
ln_FSE3       <- Ft3std                                 # logaritmo de la desviaci?n standar de Ft
```




```{r Tabla_17 PBRs, echo=F,eval=T}
Tabla3.1<-rbind( "BDpromedio"=c(round(Bmed1/10^3,0),
                                round(Bmed2/10^3,0),
                                round(Bmed3/10^3,0)),
                 "Fmh"=c(round(Fmedian1,2),
                         round(Fmedian2,2),
                         round(Fmedian3,2)), 
                 "%BDPR_Fmh"=c(pSPR_Fmh1*100,
                               pSPR_Fmh2*100,
                               pSPR_Fmh3*100), 
                 "%BDPR_F~RMS~"=c(60,
                                  60,
                                  60),
                 "%BD_Fmh"=c(pB_Fmh1*100,
                             pB_Fmh2*100,
                             pB_Fmh3*100),
                 "%BD_F~RMS~"=c(55,
                                55,
                                55),
                 "BDo"=c(round(Bo1/10^3,0),
                         round(Bo2/10^3,0),
                         round(Bo3/10^3,0)),
                 "BD55%"=c(round(BRMS1/10^3,0),
                           round(BRMS2/10^3,0),
                           round(BRMS3/10^3,0)),
                 "BD27.5%"=c(round(BLIM1/10^3,0),
                             round(BLIM2/10^3,0),
                             round(BLIM3/10^3,0)))

colnames(Tabla3.1)<-c("Septiembre","Marzo","Julio")
kable(Tabla3.1, align = 'c')

write.csv(Tabla3.1, file="Tablas/Tabla21_PBRsporasesoria.csv")


```



```{r Fig37,warning=F, include=T, message=F, echo=F,fig.height=4.5,fig.width=9,fig.align="center",fig.path=dir.Fig,dev=fig}

BD <- ggplot() + 
     #geom_line(data=VarPobJul,aes(y=BD3, x=x, colour = "julio 2021"), linetype="solid",size=0.5)+
     #geom_line(data=VarPobMar,aes(y=BD2, x=x, colour = "marzo 2021"), linetype="dashed",size=0.5)+
     geom_line(data=VarPobSep,aes(y=BD1, x=x, colour = "septiembre 2021"), linetype="solid",size=0.5)+
     #geom_ribbon(data=VarPobJul,aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "IC_julio2021"), alpha = 0.2)+
     #geom_ribbon(data=VarPobMar,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = ""), alpha = 0.2)+
     geom_ribbon(data=VarPobSep,aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = ""), alpha = 0.2)+
     geom_hline(yintercept = c(BRMS1,BLIM1,Bo1,Bmed1),colour=c('green3','red','blue','black'))+
     annotate("text", x=c(rep(2000,3),2012), y=c(BRMS1*1.1,BLIM1*1.1,Bo1*1.1,Bmed1*1.1),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]),expression("BD"[promedio]))) +
     labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1960, to = 2022, by = 4)) +
     scale_colour_manual("",values=c("black"))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top",legend.text = element_text(size=7))

Ft <- ggplot() + 
    #geom_line(data=VarPobJul,aes(y=Ft3, x=x, colour = "julio 2021"),linetype="solid", size=0.5)+
    #geom_line(data=VarPobMar,aes(y=Ft2, x=x, colour = "marzo 2021"), linetype="dashed",size=0.5)+
    geom_line(data=VarPobSep,aes(y=Ft1, x=x, colour = "septiembre 2021"), linetype="solid",size=0.5)+
    #geom_ribbon(data=VarPobJul,aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = "IC_julio2021"), alpha = 0.2)+
    #geom_ribbon(data=VarPobMar,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
    geom_ribbon(data=VarPobSep,aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = "IC"), alpha = 0.2)+
     geom_hline(yintercept = c(FRMS1,median(VarPobSep$Ft1)),colour=c('green3','black')) +
     annotate("text", x=c(2016,2003), y=c(FRMS1*1.02, median(exp(ln_Fyr1)))*1.2, label=c(expression("F"[RMS]), expression("F"[mh]))) +
    labs(x = '', y = 'Mortalidad por pesca (1/año)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2022, by = 4)) +
    scale_colour_manual("",values=c("black"))+
    scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD + Ft

```




```{r Fig38,warning=F, include=T, message=F, echo=F,fig.height=3.5,fig.width=7.5,fig.align="center",fig.path=dir.Fig,dev=fig}

sel_Flota <- rep1$Sel_flota[1,]
madurez   <- dat1$madurezsexual
Fspr      <- SPRcurv1[,1]
BDspr     <- SPRcurv1[,4]

g1 <- ggplot () +
     #lineas
     geom_line(aes(x=age,y=sel_Flota))+
     geom_line(aes(x=age,y=madurez),linetype="dashed")+
     #puntos
     geom_point(aes(x=age,y=sel_Flota,shape="Selectividad de la flota"),size=2.5) +
     geom_point(aes(x=age,y=madurez,shape="Madurez sexual"),size=2.5) +
     #parámetros
     labs(x = 'Edad (años)', y = 'Madurez y selectividad',shape="") +
     ggtitle("")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.justification=c(1.1,0), legend.position=c(1,0.1))


g2 <- ggplot () +
     geom_line(aes(x=Fspr,y=BDspr))+
     geom_hline(yintercept = 0.6,colour=c('gray35'),linetype="dashed") +
     geom_vline(xintercept = FRMS1,colour=c('gray35'),linetype="dashed") +
     annotate("text", x=2, y=0.6+0.02,label=c(expression("F"[RMS]))) +
     labs(x = 'Mortalidad por pesca (F)', y = '%BDPR',shape="") +
     ggtitle("")+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.justification=c(1.1,0), legend.position=c(1,0.1))
g1 + g2
```



```{r Estatus_sept, echo=F,message=FALSE, warning=FALSE, include=T}

years1<-rep1$years
nyears1<-length(years1)
#para serie histórica
Rpr1     <- c(subset(std1,name=="RPRequ3")$value); 
Rpr1std  <- c(subset(std1,name=="RPRequ3")$std)
Frpr1    <- c(subset(std1,name=="Frpr")$value); 
Frpr1std <- c(subset(std1,name=="Frpr")$std)

EstatusSep<- data.frame(x=years1, 
                        Rpr1=Rpr1,
                        Frpr1=Frpr1,
                        lowerRpr1  = (Rpr1 - 1.96*Rpr1std ), 
                        upperRpr1  = (Rpr1 +1.96*Rpr1std ),
                        lowerFrpr1 = (Frpr1 -1.96*Frpr1std), 
                        upperFrpr1 = (Frpr1 +1.96*Frpr1std))

#Para densidad de probabilidad
rprSEPT     <-subset(std1,name=="RPRequ3")$value[nyears1]
rprSEPTstd  <-subset(std1,name=="RPRequ3")$std[nyears1]
FrprSEPT    <-subset(std1,name=="Frpr")$value[nyears1]
FrprSEPTstd <-subset(std1,name=="Frpr")$std[nyears1]

# biomasa desovante vs BDrms
xbs1 <-rnorm(1000, mean = rprSEPT, sd = rprSEPTstd)
xbs  <-seq(min(xbs1),max(xbs1),0.005)
ybs  <-dnorm(xbs, mean = rprSEPT, sd =rprSEPTstd)
icbs <-qnorm(c(0.05,0.95,0.5),rprSEPT,rprSEPTstd)

# mortalidad por pesca vs Frms
xfs1 <- rnorm(1000, mean = FrprSEPT, sd = FrprSEPTstd)
xfs  <-seq(min(xfs1),max(xfs1),0.005)
yfs  <-dnorm(xfs, mean = FrprSEPT, sd =FrprSEPTstd)
icfs <-qnorm(c(0.05,0.95,0.5),FrprSEPT,FrprSEPTstd)

#distribución probabilidad
xxbs      <- c(xbs[xbs>=icbs[1]&xbs<=icbs[2]],
               rev(xbs[xbs>=icbs[1]&xbs<=icbs[2]]))

yybs      <- c(ybs[xbs>=icbs[1]&xbs<=icbs[2]],
               rep(0,length(ybs[xbs>=icbs[1]&xbs<=icbs[2]])))

xxfs      <- c(xfs[xfs>=icfs[1]&xfs<=icfs[2]],
               rev(xfs[xfs>=icfs[1]&xfs<=icfs[2]]))

yyfs      <- c(yfs[xfs>=icfs[1]&xfs<=icfs[2]],
               rep(0,length(yfs[xfs>=icfs[1]&xfs<=icfs[2]])))

densb_bs  <- data.frame(x=xxbs, y=yybs , t=rep('a', length(xxbs)), r=seq(1,length(xxbs),1))
densb_fs  <- data.frame(x=xxfs, y=yyfs , t=rep('a', length(xxfs)), r=seq(1,length(xxfs),1))

### *Probabilidad de estar bajo BRMS*
#Asesoría Septiembre #P(BD<BDrms) 
pa_sept<-pnorm(1,rprSEPT,rprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar bajo FRMS*
#Asesoría Septiembre #P(F>Frms)
pb_sept<-1-pnorm(1,FrprSEPT,FrprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de sobreexplotacion*
#Asesoría Septiembre #P(BD<BDrms) 
pc_sept<-pnorm(0.9,rprSEPT,rprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de colapso*
#Asesoría Septiembre #P(BD<BDrms) 
pd_sept<-pnorm(0.5,rprSEPT,rprSEPTstd,lower.tail = TRUE,log.p = F)
### *Probailidad de sobrepesca*
#Asesoría Septiembre #P(F>Frms)
pe_sept<-1-pnorm(1.1,FrprSEPT,FrprSEPTstd,lower.tail = TRUE,log.p = F)
```



## 3.7. Estatus

```{r Estatus_marzo, echo=F,message=FALSE, warning=FALSE, include=T}

years2<-rep2$years
nyears2<-length(years2)

#para serie histórica indicadores del estatus
Rpr2     <- subset(std2,name=="RPRequ3")$value; 
Rpr2std  <- subset(std2,name=="RPRequ3")$std
Frpr2    <- subset(std2,name=="Frpr")$value; 
Frpr2std <- subset(std2,name=="Frpr")$std

EstatusMar<- data.frame(x=years2, 
                        Rpr2=Rpr2,
                        Frpr2=Frpr2,
         lowerRpr2  = (Rpr2 - 1.96*Rpr2std ),
         upperRpr2   = (Rpr2 +1.96*Rpr2std ),
         lowerFrpr2 = (Frpr2 -1.96*Frpr2std), 
         upperFrpr2 = (Frpr2+1.96*Frpr2std))

#Para densidad de probabilidad
rprMARZO     <-subset(std2,name=="RPRequ3")$value[nyears2]
rprMARZOstd  <-subset(std2,name=="RPRequ3")$std[nyears2]
FrprMARZO    <-subset(std2,name=="Frpr")$value[nyears2]
FrprMARZOstd <-subset(std2,name=="Frpr")$std[nyears2]
# biomasa desovante vs BDrms - densidad de probabilidad
xbm1 <-rnorm(1000, mean = rprMARZO, sd = rprMARZOstd)
xbm  <-seq(min(xbm1),max(xbm1),0.005)
ybm  <-dnorm(xbm, mean = rprMARZO, sd =rprMARZOstd)
icbm <-qnorm(c(0.05,0.95,0.5),rprMARZO,rprMARZOstd)
# mortalidad por pesca vs Frms - densidad de probabilidad
xfm1 <- rnorm(1000, mean = FrprMARZO, sd = FrprMARZOstd)
xfm  <-seq(min(xfm1),max(xfm1),0.005)
yfm  <-dnorm(xfm, mean = FrprMARZO, sd =FrprMARZOstd)
icfm <-qnorm(c(0.05,0.95,0.5),FrprMARZO,FrprMARZOstd)
#distribución probabilidad
xxbm      <- c(xbm[xbm>=icbm[1]&xbm<=icbm[2]],
               rev(xbm[xbm>=icbm[1]&xbm<=icbm[2]]))

yybm      <- c(ybm[xbm>=icbm[1]&xbm<=icbm[2]],
               rep(0,length(ybm[xbm>=icbm[1]&xbm<=icbm[2]])))

xxfm      <- c(xfm[xfm>=icfm[1]&xfm<=icfm[2]],
               rev(xfm[xfm>=icfm[1]&xfm<=icfm[2]]))

yyfm      <- c(yfm[xfm>=icfm[1]&xfm<=icfm[2]],
               rep(0,length(yfm[xfm>=icfm[1]&xfm<=icfm[2]])))

densb_bm  <- data.frame(x=xxbm, y=yybm , t=rep('a', length(xxbm)), r=seq(1,length(xxbm),1))
densb_fm  <- data.frame(x=xxfm, y=yyfm , t=rep('a', length(xxfm)), r=seq(1,length(xxfm),1))

### *Probabilidad de estar bajo BRMS*
#Asesoría marzo #P(BD<BDrms) 
pa_mar<-pnorm(1,rprMARZO,rprMARZOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar bajo FRMS*
#Asesoría marzo #P(F>Frms)
pb_mar<-1-pnorm(1,FrprMARZO,FrprMARZOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de sobreexplotacion*
#Asesoría marzo #P(BD<BDrms) 
pc_mar<-pnorm(0.9,rprMARZO,rprMARZOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de colapso*
#Asesoría marzo #P(BD<BDrms) 
pd_mar<-pnorm(0.5,rprMARZO,rprMARZOstd,lower.tail = TRUE,log.p = F)
### *Probailidad de sobrepesca*
#Asesoría marzo #P(F>Frms)
pe_mar<-1-pnorm(1.1,FrprMARZO,FrprMARZOstd,lower.tail = TRUE,log.p = F)

```

```{r Estatus_julio, echo=F,message=FALSE, warning=FALSE, include=T}

years3  <-rep3$years
nyears3 <-length(years3)

#para serie histórica indicadores del estatus
Rpr3     <- subset(std3,name=="RPRequ3")$value; 
Rpr3std  <- subset(std3,name=="RPRequ3")$std
Frpr3    <- subset(std3,name=="Frpr")$value; 
Frpr3std <- subset(std3,name=="Frpr")$std

EstatusJul<- data.frame(x=years3,
                        Rpr3=Rpr3,
                        Frpr3=Frpr3,
         lowerRpr3   = (Rpr3  -1.96*Rpr3std ), 
         upperRpr3   = (Rpr3 +1.96*Rpr3std ),
         lowerFrpr3  = (Frpr3 -1.96*Frpr3std), 
         upperFrpr3  = (Frpr3 +1.96*Frpr3std))

#Para densidad de probabilidad
rprJULIO     <-subset(std3,name=="RPRequ3")$value[nyears3]
rprJULIOstd  <-subset(std3,name=="RPRequ3")$std[nyears3]
FrprJULIO    <-subset(std3,name=="Frpr")$value[nyears3]
FrprJULIOstd <-subset(std3,name=="Frpr")$std[nyears3]
# biomasa desovante vs BDrms - densidad de probabilidad
xbj1 <-rnorm(1000, mean = rprJULIO, sd = rprJULIOstd)
xbj  <-seq(min(xbj1),max(xbj1),0.005)
ybj  <-dnorm(xbj, mean = rprJULIO, sd =rprJULIOstd)
icbj <-qnorm(c(0.05,0.95,0.5),rprJULIO,rprJULIOstd)
# mortalidad por pesca vs Frms - densidad de probabilidad
xfj1 <- rnorm(1000, mean = FrprJULIO, sd = FrprJULIOstd)
xfj  <-seq(min(xfj1),max(xfj1),0.005)
yfj  <-dnorm(xfj, mean = FrprJULIO, sd =FrprJULIOstd)
icfj <-qnorm(c(0.05,0.95,0.5),FrprJULIO,FrprJULIOstd)
#distribución probabilidad
xxbj      <- c(xbj[xbj>=icbj[1]&xbj<=icbj[2]],rev(xbj[xbj>=icbj[1]&xbj<=icbj[2]]))
yybj      <- c(ybj[xbj>=icbj[1]&xbj<=icbj[2]],rep(0,length(ybj[xbj>=icbj[1]&xbj<=icbj[2]])))
xxfj      <- c(xfj[xfj>=icfj[1]&xfj<=icfj[2]],rev(xfj[xfj>=icfj[1]&xfj<=icfj[2]]))
yyfj      <- c(yfj[xfj>=icfj[1]&xfj<=icfj[2]],rep(0,length(yfj[xfj>=icfj[1]&xfj<=icfj[2]])))

densb_bj  <- data.frame(x=xxbj, y=yybj , t=rep('a', length(xxbj)), r=seq(1,length(xxbj),1))
densb_fj  <- data.frame(x=xxfj, y=yyfj , t=rep('a', length(xxfj)), r=seq(1,length(xxfj),1))

### *Probabilidad de estar bajo BRMS*
#Asesoría julio #P(BD<BDrms) 
pa_jul<-pnorm(1,rprJULIO,rprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar bajo FRMS*
#Asesoría julio#P(F>Frms)
pb_jul<-1-pnorm(1,FrprJULIO,FrprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de sobreexplotacion*
#Asesoría julio #P(BD<BDrms) 
pc_jul<-pnorm(0.9,rprJULIO,rprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de colapso*
#Asesoría julio #P(BD<BDrms) 
pd_jul<-pnorm(0.5,rprJULIO,rprJULIOstd,lower.tail = TRUE,log.p = F)
### *Probailidad de sobrepesca*
#Asesoría julio #P(F>Frms)
pe_jul<-1-pnorm(1.1,FrprJULIO,FrprJULIOstd,lower.tail = TRUE,log.p = F)

```

\pagebreak


```{r Fig39,warning=F, include=T, message=F, echo=F,fig.height=6.5,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig}

BD_BDrms <- ggplot() + 
     #geom_line(data=EstatusJul,aes(y=Rpr3, x=x, colour = "julio 2021"), linetype="solid", size=0.5)+
     #geom_line(data=EstatusMar,aes(y=Rpr2, x=x, colour = "marzo 2021"), linetype="dashed",size=0.5)+
     geom_line(data=EstatusSep,aes(y=Rpr1, x=x, colour = "septiembre 2021"), linetype="solid",size=0.5)+
     #geom_ribbon(data=EstatusJul,aes(ymin=lowerRpr3, ymax=upperRpr3, x=x, fill = "IC_julio2021"), alpha = 0.2)+
    # geom_ribbon(data=EstatusMar,aes(ymin=lowerRpr2, ymax=upperRpr2, x=x, fill = ""), alpha = 0.2)+
     geom_ribbon(data=EstatusSep,aes(ymin=lowerRpr1, ymax=upperRpr1, x=x, fill = ""), alpha = 0.2)+
     geom_hline(yintercept = c(1,0.5),colour=c('green3','red'))+
     annotate("text", x=c(2012,2012), y=c(1,0.5)+0.06,
              label=c(expression("BD"[RMS]),expression("BD"[LIM]))) +
     labs(x = '', y = expression("BD/BD"[RMS]),colour='Asesorías',tag="a)")  +
     scale_x_continuous(breaks = seq(from = 1960, to = 2062, by = 2)) +
     scale_colour_manual("",values=c("black"))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

F_Frms <- ggplot() + 
    #geom_line(data=EstatusJul,aes(y=Frpr3, x=x, colour = "julio 2021"), linetype="solid",size=0.5)+
    #geom_line(data=EstatusMar,aes(y=Frpr2, x=x, colour = "marzo 2021"), linetype="dashed",size=0.5)+
    geom_line(data=EstatusSep,aes(y=Frpr1, x=x, colour = "septiembre 2021"), linetype="solid",size=0.5)+
    #geom_ribbon(data=EstatusJul,aes(ymin=lowerFrpr3, ymax=upperFrpr3, x=x, fill = "IC_julio2021"), alpha = 0.2)+
    #geom_ribbon(data=EstatusMar,aes(ymin=lowerFrpr2, ymax=upperFrpr2, x=x, fill = ""), alpha = 0.2)+
    geom_ribbon(data=EstatusSep,aes(ymin=lowerFrpr1, ymax=upperFrpr1, x=x, fill = "IC"), alpha = 0.2)+
     geom_hline(yintercept = 1,colour=c('green3')) +
     annotate("text", x=2012, y=1+0.25,label=c(expression("F"[RMS]))) +
    labs(x = '', y = expression("F/F"[RMS]),colour='Asesorías',tag="c)")  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2062, by = 2)) +
    scale_colour_manual("",values=c("black"))+
     scale_linetype_manual(values=c("solid"))+
     scale_fill_manual("",values=c("grey60"))+
     theme_bw(base_size=10) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

fig_desnb<- ggplot() + lims(y=c(0,4)) +
     #geom_polygon(data=densb_bj,aes(x=x, y=y, group=t,alpha=0.9),fill="gray80")+
     #geom_polygon(data=densb_bm,aes(x=x, y=y, group=t,alpha=0.9),fill="gray70")+
     geom_polygon(data=densb_bs,aes(x=x, y=y, group=t,alpha=0.9),fill="gray55")+
     #geom_line(aes(xbj,ybj), size=0.3,color="blue",linetype="solid")+
     #geom_line(aes(xbm,ybm), size=0.3,color="red",linetype="dashed")+
     geom_line(aes(xbs,ybs), size=0.3,color="black",linetype="solid")+
     annotate("text", x=c(0.5), y=c(3.9), colour = c("black"), size = 2.5,
              label=c(paste("IC95%_sept2021 = [",round(icbs[1],3),"-",round(icbs[2],3),"]",sep=" "))) +
     labs(x = expression("BD"[2021]*"/BD"[RMS]), y = 'Densidad de probabilidad',tag="b)")  +
     theme_bw(base_size=10) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

fig_desnf<- ggplot() + lims(y=c(0,2))+
     #geom_polygon(data=densb_fj,aes(x=x, y=y, group=t,alpha=0.9),fill="gray80")+
     #geom_polygon(data=densb_fm,aes(x=x, y=y, group=t,alpha=0.9),fill="gray70")+
     geom_polygon(data=densb_fs,aes(x=x, y=y, group=t,alpha=0.9),fill="gray55")+
     #geom_line(aes(xfj,yfj), size=0.3,color="blue",linetype="solid")+
     #geom_line(aes(xfm,yfm), size=0.3,color="red",linetype="dashed")+
     geom_line(aes(xfs,yfs), size=0.3,color="black",linetype="solid")+
     annotate("text", x=c(0.9), y=c(1.9), colour = c("black"), size = 2.5,
              label=c(paste("IC95%_sept2021  = [",round(icfs[1],3),"-",round(icfs[2],3),"]",sep=" "))) +
     labs(x = expression("F"[2021]*"/F"[RMS]), y = 'Densidad de probabilidad',tag="d)")  +
     theme_bw(base_size=10) +
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")


 {(BD_BDrms / F_Frms)   | (fig_desnb/fig_desnf)} +  plot_layout(ncol=2,widths=c(2,1))
 

```




```{r Tabla_29, echo=F,warning=FALSE}
yearsb<-c("1990/91","1991/92","1992/93","1993/94","1994/95","1995/96","1996/97","1997/98","1998/99","1999/00","2000/01","2001/02","2002/03","2003/04","2004/05","2005/06","2006/07","2007/08","2008/09","2009/10","2010/11","2011/12","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18","2018/19","2019/20",'2020/21')

VarPobl2<- cbind('Años'=yearsb,
                 "$F/F_{RMS_{sept}}$"=c(round(exp(Ft1)/FRMS1,3)),
                 "$F/F_{RMS_{marzo}}$"=c(round(exp(Ft2)/FRMS2,3)),
                 "$F/F_{RMS_{julio}}$"=c(round(exp(Ft3)/FRMS3,3)),
                 "$BD/BD_{RMS_{sept}}$"=c(round(BD1/BRMS1,3)),
                 "$BD/BD_{RMS_{marzo}}$"=c(round(BD2/BRMS2,3)),
                 "$BD/BD_{RMS_{julio}}$"=c(round(BD3/BRMS3,3)))
kable(VarPobl2, align = 'c')

#setwd(dir.basedatos)
write.csv(VarPobl2, file="Tablas/Tabla_22_indicesReduccion.csv")
#setwd(dir.1)

```


```{r Tabla_29b, echo=F,warning=FALSE}
yearsb<-c("1990/91","1991/92","1992/93","1993/94","1994/95","1995/96","1996/97","1997/98","1998/99","1999/00","2000/01","2001/02","2002/03","2003/04","2004/05","2005/06","2006/07","2007/08","2008/09","2009/10","2010/11","2011/12","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18","2018/19","2019/20",'2020/21')

VarPobl2b<- cbind('Años'=yearsb,
                 "$Y/BT_{sept}$"=c(round(rep1$desembarquepred/BT1,3)),
                  "$Y/BT_{marzo}$"=c(round(rep2$desembarquepred/BT2,3)),
                 "$Y/BT_{julio}$"=c(round(rep3$desembarquepred/BT3,3)),
                 "$C/N_{sept}$"=c(round(c(rowSums(rep1$pred_Ctot)/rowSums(rep1$N)),3)),
                  "$C/N_{marzo}$"=c(round(rowSums(rep2$pred_Ctot)/rowSums(rep2$N),3)),
                 "$C/N_{julio}$"=c(round(rowSums(rep3$pred_Ctot)/rowSums(rep3$N),3)))
kable(VarPobl2b, align = 'c')

#setwd(dir.basedatos)
write.csv(VarPobl2b, file="Tablas/Tabla_23_tasasExplotacion.csv")
#setwd(dir.1)

```



```{r Fig40, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=4,fig.align="center",fig.path=dir.Fig,dev=fig}
source(paste(dir.fun,"Fn_DiagramaFase2.R",sep=""))
name1<-"Asesoría de Septiembre 2021"
years1<-rep1$years
nyears1<-length(years1)

DiagramaFase2(name1,
             years1[1:nyears1-1],
             SpB1[1:nyears1-1],
             SpBSE1[1:nyears1-1],
             ln_Fyr1[1:nyears1-1],
             ln_FSE1[1:nyears1-1],
             SpB1[nyears1],
             SpBSE1[nyears1],
             ln_Fyr1[nyears1],
             ln_FSE1[nyears1],
             FRMS1,
             BRMS1,
             BLIM1,
             FLIM1,
             color=F,
             dir.1,
             etiqueta=F,
             preliminar=F,
             completo=T)

text(c(SpB1[1]/BRMS1,SpB1[nyears1]/BRMS1,SpB1[nyears1-1]/BRMS1),
     c(exp(ln_Fyr1[1])/FRMS1-0.05,exp(ln_Fyr1[nyears1])/FRMS1-0.05,exp(ln_Fyr1[nyears1-1])/FRMS1+0.05), c("1990/91","2020/21","2019/20"),cex=0.8)

```



```{r Fig41, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=4,fig.align="center",fig.path=dir.Fig,dev=fig}
source(paste(dir.fun,"Fn_DiagramaFase2.R",sep=""))
name2<-"Asesoría de Marzo 2021"
years2<-rep2$years
nyears2<-length(years2)

DiagramaFase2(name2,
             years2[1:nyears2-1],
             SpB2[1:nyears2-1],
             SpBSE2[1:nyears2-1],
             ln_Fyr2[1:nyears2-1],
             ln_FSE2[1:nyears2-1],
             SpB2[nyears2],
             SpBSE2[nyears2],
             ln_Fyr2[nyears2],
             ln_FSE2[nyears2],
             FRMS2,
             BRMS2,
             BLIM2,
             FLIM2,
             color=F,
             dir.1,
             etiqueta=F,
             preliminar=T,
             completo=F)

text(c(SpB2[1]/BRMS2,SpB2[nyears2]/BRMS2,SpB2[nyears2-1]/BRMS2),
     c(exp(ln_Fyr2[1])/FRMS2-0.05,exp(ln_Fyr2[nyears2])/FRMS2-0.05,exp(ln_Fyr2[nyears2-1])/FRMS2+0.05), c("1990/91","2020/21","2019/20"),cex=1.2)

```



```{r Fig41b, warning=F, include=T, message=F, echo=F,fig.height=4,fig.width=4,fig.align="center",fig.path=dir.Fig,dev=fig}
source(paste(dir.fun,"Fn_DiagramaFase2.R",sep=""))
name3<-"Asesoría de Julio 2021"
years3<-rep3$years
nyears3<-length(years3)

DiagramaFase2(name3,
             years3[1:nyears3-1],
             SpB3[1:nyears3-1],
             SpBSE3[1:nyears3-1],
             ln_Fyr3[1:nyears3-1],
             ln_FSE3[1:nyears3-1],
             SpB3[nyears3],
             SpBSE3[nyears3],
             ln_Fyr3[nyears3],
             ln_FSE3[nyears3],
             FRMS3,
             BRMS3,
             BLIM3,
             FLIM3,
             color=F,
             dir.1,
             etiqueta=F,
             preliminar=F,
             completo=T)

text(c(SpB3[1]/BRMS3,SpB3[nyears3]/BRMS3,SpB3[nyears3-1]/BRMS3),
     c(exp(ln_Fyr3[1])/FRMS3-0.05,exp(ln_Fyr3[nyears3])/FRMS3-0.05,exp(ln_Fyr3[nyears3-1])/FRMS3+0.05), c("1990/91","2020/21","2019/20"),cex=1.2)

```




```{r Tabla26, echo=F}
Tabla4.1<-rbind("Año biológico"=c("2020/21",
                                  "2020/21",
                                  "2020/21"),
                "$F_{RMS}$"=c(round(FRMS1,2),
                              round(FRMS2,2),
                              round(FRMS3,2)),
                "$BD_{RMS}$"=c(round(BRMS1/10^3,0),
                               round(BRMS2/10^3,0),
                               round(BRMS3/10^3,0)),
                "$BD_{LIM}$"=c(round(BLIM1/10^3,0),
                               round(BLIM2/10^3,0),
                               round(BLIM3/10^3,0)),
                "$p(BD_{last}<BD_{RMS})$"=round(c(pa_sept,
                                                  pa_mar,
                                                  pa_jul),2),
                "$p(F_{last}>F_{RMS})$"=round(c(pb_sept,
                                                pb_mar,
                                                pb_jul),2),
                "$p(sobre-explotación)$"=round(c(pc_sept,
                                                 pc_mar,
                                                 pc_jul),2),
                "$p(agotado/colapsado)$"=round(c(pd_sept,
                                                 pd_mar,
                                                 pd_jul),2),
                "$p(sobrepesca)$"=round(c(pe_sept,
                                          pe_mar,
                                          pe_jul),2))
colnames(Tabla4.1)<-c("Septiembre 2021","Marzo 2021","Julio 2021")
kable(Tabla4.1,align='c')
```

\pagebreak

## 3.8. CBA 2021 Inicial (Asesoría de septiembre 2021)


```{r proyecciona,warning=F, include=T, message=F,eval=T, echo=F}

dira<-paste(dir.0,"/CBA_sept/",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAE092111.rep")  
reps2a     <- reptoRlist("MAE092112.rep") 
reps3a     <- reptoRlist("MAE092113.rep") 

carpeta<-"/CBA_sept/"
stds1     <- read.table(paste(dir.0,carpeta,"MAE092111.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds2     <- read.table(paste(dir.0,carpeta,"MAE092112.std", sep=''),header=T,sep="",na="NA",fill=T) 
stds3     <- read.table(paste(dir.0,carpeta,"MAE092113.std", sep=''),header=T,sep="",na="NA",fill=T) 

bds1     <- subset(stds1,name=="BD_p0")$value ; 
bds1std  <- subset(stds1,name=="BD_p0")$std #reclutamiento medios
bds2     <- subset(stds2,name=="BD_p0")$value ; 
bds2std  <- subset(stds2,name=="BD_p0")$std #reclutamiento 2018
bds3     <- subset(stds3,name=="BD_p0")$value ; 
bds3std  <- subset(stds3,name=="BD_p0")$std #reclutamiento 2012

RpRps1     <- subset(stds1,name=="RPR_p0")$value ; 
RpRps1std  <- subset(stds1,name=="RPR_p0")$std #reclutamiento medios
RpRps2     <- subset(stds2,name=="RPR_p0")$value ; 
RpRps2std  <- subset(stds2,name=="RPR_p0")$std #reclutamiento 2018
RpRps3     <- subset(stds3,name=="RPR_p0")$value ; 
RpRps3std  <- subset(stds3,name=="RPR_p0")$std #reclutamiento 2012

cs1     <- subset(stds1,name=="YTP_p0")$value ; 
cs1std  <- subset(stds1,name=="YTP_p0")$std #reclutamiento medios
cs2     <- subset(stds2,name=="YTP_p0")$value ; 
cs2std  <- subset(stds2,name=="YTP_p0")$std #reclutamiento 2018
cs3     <- subset(stds3,name=="YTP_p0")$value ; 
cs3std  <- subset(stds3,name=="YTP_p0")$std #reclutamiento 2012


```



```{r estatusproyectado,warning=F, include=T, message=F, echo=F}

# PRIMER AÑO PROYECTADO
#######################################################################################
### *Probabilidad de estar bajo BRMS* 
#######################################################################################
pa1<-pnorm(1,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pa2<-pnorm(1,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pa3<-pnorm(1,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de sobreexplotacion*
#######################################################################################
pc1<-pnorm(0.9,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pc2<-pnorm(0.9,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pc3<-pnorm(0.9,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de colapso*
#######################################################################################
pd1<-pnorm(0.5,RpRps1[1],RpRps1std[1],lower.tail = TRUE,log.p = F)
pd2<-pnorm(0.5,RpRps2[1],RpRps2std[1],lower.tail = TRUE,log.p = F)
pd3<-pnorm(0.5,RpRps3[1],RpRps3std[1],lower.tail = TRUE,log.p = F)

#######################################################################################
probEstatus<-round(rbind("BD~RMS~ (mil t)"=c(BRMS1)/1000,
                   'BD~2022~ (mil t)'=round(c(bds1[1],bds2[1],bds3[1])/1000,0),
                   'C~2022~ (mil t)'=round(c(cs1[1],cs2[1],cs3[1])/1000,0),
                   'C~1erS2022~ ( mil t)'=round(c((cs1[1])*0.7,(cs2[1])*0.7,(cs3[1])*0.7)/1000,0),
                   'C~2022~ (-descarte mil t)'=round(c(cs1[1]*0.96,cs2[1]*0.96,cs3[1]*0.96)/1000,0),
                   'C~1erS2022~ (-descarte mil t)'=round(c((cs1[1]*0.96)*0.7,(cs2[1]*0.96)*0.7,(cs3[1]*0.96)*0.7)/1000,0),
                   'BD~2022~/BD~RMS~'=round(c(RpRps1[1],RpRps2[1],RpRps3[1]),2),
                   "*p(BD~2022~<BD~RMS~)*"=round(c(pa1,pa2,pa3),2),
                  "*p(sobreexplotación)*"=round(c(pc1,pc2,pc3),2),
                  "*p(agotado/colapsado)*"=round(c(pd1,pd2,pd3),2)),2)

colnames(probEstatus)<-c("R1",'R2','R3')
kable(probEstatus)
#######################################################################################

# SEGUNDO AÑO PROYECTADO

#######################################################################################
### *Probabilidad de estar bajo BRMS* 
#######################################################################################
pa12<-pnorm(1,RpRps1[2],RpRps1std[2],lower.tail = TRUE,log.p = F)
pa22<-pnorm(1,RpRps2[2],RpRps2std[2],lower.tail = TRUE,log.p = F)
pa32<-pnorm(1,RpRps3[2],RpRps3std[2],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de sobreexplotacion*
#######################################################################################
pc12<-pnorm(0.9,RpRps1[2],RpRps1std[2],lower.tail = TRUE,log.p = F)
pc22<-pnorm(0.9,RpRps2[2],RpRps2std[2],lower.tail = TRUE,log.p = F)
pc32<-pnorm(0.9,RpRps3[2],RpRps3std[2],lower.tail = TRUE,log.p = F)
#######################################################################################
### *Probabilidad de estar en zona de colapso*
#######################################################################################
pd12<-pnorm(0.5,RpRps1[2],RpRps1std[2],lower.tail = TRUE,log.p = F)
pd22<-pnorm(0.5,RpRps2[2],RpRps2std[2],lower.tail = TRUE,log.p = F)
pd32<-pnorm(0.5,RpRps3[2],RpRps3std[2],lower.tail = TRUE,log.p = F)

#######################################################################################
probEstatus2y<-round(rbind("BD~RMS~ (mil t)"=c(BRMS1)/1000,
                   'BD~2023~ (mil t)'=round(c(bds1[2],bds2[2],bds3[2])/1000,0),
                    'C~2023~ (mil t)'=round(c(cs1[2],cs2[2],cs3[2])/1000,0),
                   'C~2doS2022~ ( mil t)'=round(c((cs1[2])*0.3,(cs2[2])*0.3,(cs3[2])*0.3)/1000,0),
                   'C~2023~ (-descarte mil t)'=round(c(cs1[2]*0.96,cs2[2]*0.96,cs3[2]*0.96)/1000,0),
                   'C~2doS2022~ (-descarte mil t)'=round(c((cs1[2]*0.96)*0.3,(cs2[2]*0.96)*0.3,(cs3[2]*0.96)*0.3)/1000,0),
                   'BD~2023~/BD~RMS~'=round(c(RpRps1[2],RpRps2[2],RpRps3[2]),2),
                   "*p(BD~2023~<BD~RMS~)*"=round(c(pa12,pa22,pa32),2),
                  "*p(sobreexplotación)*"=round(c(pc12,pc22,pc32),2),
                  "*p(agotado/colapsado)*"=round(c(pd12,pd22,pd32),2)),2)

colnames(probEstatus2y)<-c("R1",'R2','R3')
kable(probEstatus2y)
#######################################################################################


```



```{r Fig34a, warning=F, include=T, message=F,eval=T, echo=F,fig.height=7,fig.width=9,fig.align="center",fig.path="Figuras/",dev=fig}
par(mfrow=c(2,2),mar=c(4,4,1,1)+0.5)
yearProy<-c(2022,2023)

#=======================================================
# plot reclutamientos 
plot(c(reps1a$years,yearProy),c(reps1a$Reclutas,NA,NA),type="o",
     ylab="Reclutamientos",xlab="Años",main="",
     cex.axis=1,cex.main=1,cex.lab=1,xlim=c(1991,2025),pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,reps2a$Np[1],reps2a$Np[1]),type="o",col=2,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,reps3a$Np[1],reps3a$Np[1]),type="o",col=3,pch=19)

lines(c(reps1a$years,yearProy),
      c(reps1a$Reclutas,reps1a$Np[1],reps1a$Np[1]),type="o",col=1,pch=19)

abline(h=c(reps1a$Np[1],
           reps2a$Np[1],
           reps3a$Np[1]),
       col=c(1,2,3))

text(2025,c(reps1a$Np[1],
            reps2a$Np[1],
            reps3a$Np[1])+15000,
     round(c(reps1a$Np[1]/1000,
             reps2a$Np[1]/1000,
             reps3a$Np[1]/1000),0),cex=0.7)
text(2024,550000,"a)")
#=======================================================
# plot Biomasa desovante
plot(c(rep1$years,yearProy),
     c(rep1$SSB,bds3),
     type="o",ylab="Biomasa desovante (t)",xlab="Años",col=3,
     xlim=c(1991,2025),pch=19,main="")

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds2),
      type="o",col=2,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds1),type="o",col=1,pch=19)

abline(v=yearProy[1]-1,lty=2)
legend(2000,2000000,c("Reclprom 1991-2007","Reclprom 2008-2012","Reclprom 2013-2021"),pch=19,lwd=1,col=c(1,2,3),bty="n")
text(2024,2000000,"b)")
#=======================================================
# plot bd/BDrms
plot(c(rep1$years,yearProy),
     c(rep1$SSB,bds3)/BRMS1,
     type="o",ylab="BD/BDrms",col=3,xlab="Años",pch=19,xlim=c(1991,2025),ylim=c(0,3.1))

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds2)/BRMS1,
      type="o",col=2,pch=19)

lines(c(rep1$years,yearProy),
      c(rep1$SSB,bds1)/BRMS1,
      type="o",col=1,pch=19)

abline(v=yearProy[1]-1,h=1,lty=2)
abline(h=0.5,lty=2,col=2)
text(2024,3,"c)")

#=======================================================
# plot capturas proyectadas
plot(c(rep1$years,yearProy),
     c(rep1$desembarquepred,cs3),type="o",
     ylab="Capturas (t)",col=3,xlab="Años",pch=19,xlim=c(1991,2025),)
lines(c(rep1$years,yearProy),
      c(rep1$desembarquepred,cs2),
      type="o",col=2,pch=19)
lines(c(rep1$years,yearProy),
      c(rep1$desembarquepred,cs1),
      type="o",col=1,pch=19)
abline(v=yearProy[1]-1,lty=2)
text(2024,820000,"d)")

```



## 4.0.  Proyección del stock (Asesoría de septiembre 2021)

```{r Tabla32_CBA_septiembre, echo=FALSE, warning=F, include=T, message=F}
dir.4<-paste(dir.0,"/CBA_sept/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA     <- matrix(ncol=nq,nrow=nes)
CBAp    <- matrix(ncol=1,nrow=1)
CBApstd <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE09211",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA[i,j]<-qnorm(q[j],CBAp[i],CBApstd[i])}}

```




```{r Tabla_32a,eval=T, warning=F, include=T, message=F, echo=FALSE}
source(paste(dir.fun,"Fn_Estatus_proy.R",sep=""))
setwd(paste(dir.0,"/CBA_sept/",sep=""))
mfyr<-c(11,21,31)
escR<-"1991-2007"
Estatusproy_sept("MAE0921",mfyr,escR,year1="2019/20",year2="2020/21",year3="2021/22",year4="2022/23")
```

```{r Tabla_32b,eval=T, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_sept/",sep=""))
mfyr<-c(12,22,32)
escR<-"2008-2012"
Estatusproy_sept("MAE0921",mfyr,escR,year1="2019/20",year2="2020/21",year3="2021/22",year4="2022/23")

```

```{r Tabla_32c,eval=T, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_sept/",sep=""))
mfyr<-c(13,23,33)
escR<-"2013-2021"
Estatusproy_sept("MAE0921",mfyr,escR,year1="2019/20",year2="2020/21",year3="2021/22",year4="2022/23")
```

```{r DF_proysept, eval=T,warning=F, include=T, message=F, echo=FALSE,fig.height=2.7,fig.width=2.7}
setwd(paste(dir.0,"/CBA_sept/",sep=""))

admb_sept<-"MAE0921"
data1        <- lisread(paste(admb_sept,".dat",sep=""))#lee los datos de la ultima evaluacion
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data
rep1         <- reptoRlist(paste(admb_sept,".rep",sep=""))
std1         <- read.table(paste(admb_sept,".std",sep=""),header=T,sep="",na="NA",fill=T)  

years      <- rep1$years                                                              
nyears     <- length(years)   
Bo         <- rep1$SSBpbr[1]                         # Paso 4: Obtención de Bo
BRMS       <- rep1$SSBpbr[3]                         # Paso 5: Obtención de Brms = 60%SPRo = 55%Bo
FRMS       <- rep1$Fs[2]
BLIM       <- Bo*0.275                              # Paso 6: Obtención de Blim = 20%Bo 
FLIM       <- rep1$Fs[3]                             # Paso 6: Obtención de Flim = 30%SPRo
SpB        <- subset(std1,name=="SSB")$value                                # BD serie histórica de evaluación de stock 
SpBSE      <- subset(std1,name=="SSB")$std                           # desviación estandar BD
ln_Fyr     <- subset(std1,name=="log_Ft")$value                                # logaritmo de Ft
ln_FSE     <- subset(std1,name=="log_Ft")$std                                 # logaritmo de la desviación standar de Ft
Fyr        <- exp(subset(std1,name=="log_Ft")$value)

```

```{r Fig45a_sept, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy.R",sep=""))
source(paste(dir.fun,"Fn_ProbEstatus_proy.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(11,21,31)
admb_sept<-"MAE0921"

for(i in 1:n){
name<-escR[1]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_sept",sep=""))
rep     <- reptoRlist(paste(admb_sept,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_sept,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$value   
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprSEPT,SpBp/BRMS),
     c(FrprSEPT,Frmsp/FRMS))

points(c(SpBp/BRMS),
       c(Frmsp/FRMS),
      pch=19,col=c(2,2),cex=c(1,1))

text((SpBp/BRMS),
    c(Frmsp/FRMS-0.07),
    c("2021/22","2022/23"),cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),
     cex=0.8)
text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#nesc<-c(11,21,31)
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 1991-2007"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)

```

```{r Fig45b_sept, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(12,22,32)
admb_sept<-"MAE0921"

for(i in 1:n){
name<-escR[2]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_sept",sep=""))
rep     <- reptoRlist(paste(admb_sept,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_sept,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprSEPT,SpBp/BRMS),
      c(FrprSEPT,Frmsp/FRMS))

points(c(SpBp/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22","2022/23"),cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 2008-2012"
#nesc<-c(12,22,32)
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```

```{r Fig45c_sept, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}
escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))
pF<-rep(c("Frms*1","Frms*0.9","Frms*1.1"),3)
n<-3
nesc<-c(13,23,33)
admb_sept<-"MAE0921"

for(i in 1:n){
name<-escR[3]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_sept",sep=""))
rep     <- reptoRlist(paste(admb_sept,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_sept,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 
SpBp    <- subset(std,name=="BD_p0")$value                              
SpBSEp  <- subset(std,name=="BD_p0")$std    
Frmsp    <-c(rep$Fref,rep$Fref)

lines(c(rprSEPT,SpBp/BRMS),
      c(FrprSEPT,Frmsp/FRMS))

points(c(SpBp/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(2),cex=c(1))

text((SpBp/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22","2022/23"),
     cex=c(0.5,0.5))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),
     cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_sept",sep=""))
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#nesc<-c(13,23,33)
#name<-"Reclprom 2013-2020"
#ProbEstatusproy_sept("MAE0920",nesc,name,pF,nyears=30)
```




```{r Fig42,  warning=F, include=T, message=F, echo=FALSE,fig.height=3,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig}
library(strucchange)
years1<-rep1$years
nyears1<-length(years1)
bp.nile <- breakpoints(rep1$Reclutas/1000 ~ 1)
fm0 <- lm(rep1$Reclutas/1000 ~ 1)
fm1 <- lm(rep1$Reclutas/1000 ~ breakfactor(bp.nile, breaks = 2))
quiebres3<-fitted(fm1)

par(mfrow=c(1,1),mar=c(2,4,1,1))
plot(years1,rep1$Reclutas/1000,type="l",lty=2,pch=19,ylim=c(0,700),
     xaxp=c(1990,2020,30),yaxs="i",xlab="",ylab="Reclutamientos (miles de millones de ind.)",main="Escenarios de reclutamiento proyectado",cex.main=0.8,cex.axis=0.8,cex.lab=0.8)
points(years1,rep1$Reclutas/1000,col=1,pch=19)
lines(years1,quiebres3,lwd=2,col=4)
text(c(1999,2010,2017),c(fitted(fm1)[1],fitted(fm1)[18],fitted(fm1)[23])+20,round(c(fitted(fm1)[1],fitted(fm1)[18],fitted(fm1)[23]),0),col=2,font=1,cex=0.8)

```

\pagebreak

```{r CBAinicial_sept, eval=T, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_sept/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA_sept     <- matrix(ncol=nq,nrow=nes)
CBAp_sept    <- matrix(ncol=1,nrow=1)
CBApstd_sept <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE09211",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_sept[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd_sept[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA_sept[i,j]<-qnorm(q[j],CBAp_sept[i],CBApstd_sept[i])}}

```


```{r CBAinicial-descarte_sept, eval=T, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_sept/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBAd_sept     <- matrix(ncol=nq,nrow=nes)
CBApd_sept    <- matrix(ncol=1,nrow=1)
CBApdstd_sept <- matrix(ncol=1,nrow=1)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE09211",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBApd_sept[i]    <-subset(std,name=="CBA_c0d")$value[1]
	CBApdstd_sept[i] <-subset(std,name=="CBA_c0d")$std[1]
	for(j in 1:nq){	CBAd_sept[i,j]<-qnorm(q[j],CBApd_sept[i],CBApdstd_sept[i])}}

```

```{r Tabla25a_CBAinicial_sept,eval=T, echo=FALSE, warning=F, include=T, message=F}
tCBA<-cbind(CBAp_sept,CBApstd_sept,CBA_sept)
colnames(tCBA)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA)<-c("1991-2007","2008-2012","2013-2021")
kable(t(round(tCBA,0)))
```


```{r Tabla26_resguardo_sept, eval=T,echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
buffer[i,j]<-round(1-CBA_sept[i,j]/CBA_sept[i,5],2)}}
colnames(buffer)<-c("10%","20%","30%","40%","50%")
row.names(buffer)<-c("1991-2007","2008-2012","2013-2021")
kable(t(buffer))
```

```{r Tabla25a_CBAinicial-descarte_sept,eval=T, echo=FALSE, warning=F, include=T, message=F}
tCBAd<-cbind(CBApd_sept,CBApdstd_sept,CBAd_sept)
colnames(tCBAd)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBAd)<-c("1991-2007","2008-2012","2013-2021")
kable(t(round(tCBAd,0)))
```





```{r Fig27_CBA,warning=F, include=T, message=F, echo=F,fig.height=5,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

dira<-paste(dir.0,"/CBA_sept",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAE092111.rep")  
reps2a     <- reptoRlist("MAE092112.rep") 
reps3a     <- reptoRlist("MAE092113.rep") 

#===============================================================================================================
# escenario 1
#===============================================================================================================
xca1 <-rnorm(1000, mean = CBAp_sept[1], 
                   sd   = CBApstd_sept[1])

xca  <-seq(min(xca1),max(xca1),0.5)

yca  <-dnorm(xca, mean = CBAp_sept[1],
                  sd   = CBApstd_sept[1])

icca <-qnorm(c(0.1,0.5,0.5),CBAp_sept[1],CBApstd_sept[1])

xxca <-c(xca[xca>=icca[1]&xca<=icca[2]],
         rev(xca[xca>=icca[1]&xca<=icca[2]]))

yyca <-c(yca[xca>=icca[1]&xca<=icca[2]],
         rep(0,length(yca[xca>=icca[1]&xca<=icca[2]])))
#===============================================================================================================
# escenario 2
#===============================================================================================================
xcb1 <-rnorm(1000, mean = CBAp_sept[2], 
                   sd   = CBApstd_sept[2])

xcb  <-seq(min(xcb1),max(xcb1),0.5)

ycb  <-dnorm(xcb, mean = CBAp_sept[2], 
                  sd   = CBApstd_sept[2])

iccb <-qnorm(c(0.1,0.5,0.5),
             CBAp_sept[2],
             CBApstd_sept[2])

xxcb <-c(xcb[xcb>=iccb[1]&xcb<=iccb[2]],
         rev(xcb[xcb>=iccb[1]&xcb<=iccb[2]]))

yycb <-c(ycb[xcb>=iccb[1]&xcb<=iccb[2]],
         rep(0,length(ycb[xcb>=iccb[1]&xcb<=iccb[2]])))
#===============================================================================================================
# escenario 3
#===============================================================================================================
xcc1 <-rnorm(1000, mean = CBAp_sept[3], 
                   sd   = CBApstd_sept[3])

xcc  <-seq(min(xcc1),max(xcc1),0.5)

ycc  <-dnorm(xcc, mean = CBAp_sept[3], 
                  sd   = CBApstd_sept[3])

iccc <-qnorm(c(0.1,0.5,0.5),
             CBAp_sept[3],
             CBApstd_sept[3])

xxcc <-c(xcc[xcc>=iccc[1]&xcc<=iccc[2]],
         rev(xcc[xcc>=iccc[1]&xcc<=iccc[2]]))

yycc <-c(ycc[xcc>=iccc[1]&xcc<=iccc[2]],
         rep(0,length(ycc[xcc>=iccc[1]&xcc<=iccc[2]])))


par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================
# plot captura a la talla
plot(seq(0,4,1),reps2a$YTP_p0W_proyectada[1,],type="h",main="Año 2021/2022",lwd=20,ylim=c(0,400000),yaxs= "i",
     ylab="Captura  a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='red2')
lines(seq(0,4,1),reps3a$YTP_p0W_proyectada[1,],type="h",col='green2',lwd=15)
lines(seq(0,4,1),reps1a$YTP_p0W_proyectada[1,],type="h",col='blue2',lwd=10)
text(rep(0.35,3),c(reps1a$YTP_p0W_proyectada[1,1],reps2a$YTP_p0W_proyectada[1,1],reps3a$YTP_p0W_proyectada[1,1]),c('33%','63%','43%'))
text(4,380000,'a)')

plot(seq(0,4,1),reps2a$YTP_p0W_proyectada[2,],type="h",main="Año 2022/2023 ",lwd=20,ylim=c(0,400000),yaxs= "i",
     ylab="Captura a la edad (t)",xlab="Edades",cex.axis=1,cex.main=1,cex.lab=1,col='red2')
lines(seq(0,4,1),reps3a$YTP_p0W_proyectada[2,],type="h",col='green2',lwd=15)
lines(seq(0,4,1),reps1a$YTP_p0W_proyectada[2,],type="h",col='blue2',lwd=10)
text(rep(0.35,3),c(reps1a$YTP_p0W_proyectada[2,1],reps2a$YTP_p0W_proyectada[2,1],reps3a$YTP_p0W_proyectada[2,1]),c('38%','48%','43%'))
text(rep(1.35,3),c(reps1a$YTP_p0W_proyectada[2,2],reps2a$YTP_p0W_proyectada[2,2],reps3a$YTP_p0W_proyectada[2,2]),c('32%','41%','36%'))
text(4,380000,'b)')

par(mfrow=c(1,2),mar=c(4,4,1,1)+0.5)
#===============================================================================================================
# plot densidad de probabilidad CBA
plot(xca,yca,type="l",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",xlab="CBA 2022 (toneladas)",main="", cex.axis=1,cex.main=1,cex.lab=1,xlim=c(50000,1000000),ylim=c(0,8.5e-06))

polygon(xxca,yyca,col=gray(0.8,0.7),border="gray80")
lines(xca,yca,lwd=1,col="blue2",lty=1)

polygon(xxcb,yycb,col=gray(0.8,0.7),border="gray80")
lines(xcb,ycb,lwd=1,col="red2",lty=1)

polygon(xxcc,yycc,col=gray(0.8,0.7),border="gray80")
lines(xcc,ycc,lwd=1,col="green2",lty=1)

legend(90000,8e-06,
       c(paste("CBA2022_R1991-2007 = [",round(icca[1],0),"-",round(icca[2],0),"]",sep=" "),
         paste("CBA2022_R2008-2012 = [",round(iccb[1],0),"-",round(iccb[2],0),"]",sep=" "),
         paste("CBA2022_R2013-2021 = [",round(iccc[1],0),"-",round(iccc[2],0),"]",sep=" ")), lty=c(1,1,1),col=c('blue2',"red2","green2"),bty="n",lwd=1,cex=0.8)
text(950000,8e-06,'a)')
box()

#===============================================================================================================
# plot percentiles de captura
plot(seq(10,50,10),CBA_sept[1,],type="o", ylab="CBA 2022 (toneladas)",xlab="Percentil de Captura (P*)",main="",cex.axis=1,cex.main=1,cex.lab=1,col="blue2",ylim=c(0,800000))
lines(seq(10,50,10),CBA_sept[2,],type="o",col="red2")
lines(seq(10,50,10),CBA_sept[3,],type="o",col="green2")

legend(12,8e+05,c("R1991-2007","R2008-2012","R2013-2021"),col=c(4,2,3),pch=c(19,19,19),lwd=1,bty="n",cex=0.8)
text(49,8e+05,'b)')
#===============================================================================================================
# plot resguardo

#plot(seq(10,50,10),buffer[1,],type="o",ylim=c(0,0.35), ylab="Resguardo = (1-CBA/Crms)",xlab="Percentil de Captura (*P)",main="",lwd=2,lty=1,col='blue2')
#lines(seq(10,50,10),buffer[2,],type="o",col='red2')
#lines(seq(10,50,10),buffer[3,],type="o",col='green2')
#text(49,0.345,'d)')


C1eryearR1<-round(reps1a$YTP_p0W_proyectada[1,],0)
C1eryearR2<-round(reps2a$YTP_p0W_proyectada[1,],0)
C1eryearR3<-round(reps3a$YTP_p0W_proyectada[1,],0)

C2doyearR1<-round(reps1a$YTP_p0W_proyectada[2,],0)
C2doyearR2<-round(reps2a$YTP_p0W_proyectada[2,],0)
C2doyearR3<-round(reps3a$YTP_p0W_proyectada[2,],0)

kable(t(data.frame(C1eryearR1,C1eryearR2,C1eryearR3,C2doyearR1,C2doyearR2,C2doyearR3)))


```



## 3.9.  Primera revisión CBA 2021  (Asesoría de marzo 2021)

```{r Fig43,  warning=F, include=T, message=F, echo=FALSE,fig.height=3,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig}
library(strucchange)
years1<-rep2$years
nyears1<-length(years1)
bp.nile <- breakpoints(rep2$Reclutas/1000 ~ 1)
fm0 <- lm(rep2$Reclutas/1000 ~ 1)
fm1 <- lm(rep2$Reclutas/1000 ~ breakfactor(bp.nile, breaks = 2))
quiebres3<-fitted(fm1)

par(mfrow=c(1,1),mar=c(2,4,1,1))
plot(years1,rep2$Reclutas/1000,type="l",lty=2,pch=19,ylim=c(0,700),
     xaxp=c(1990,2021,31),yaxs="i",xlab="",ylab="Reclutamientos (miles de millones de ind.)",main="Escenarios de reclutamiento proyectado",cex.main=0.8,cex.axis=0.8,cex.lab=0.8)
points(years1,rep2$Reclutas/1000,col=1,pch=19)
lines(years1,quiebres3,lwd=2,col=4)
text(c(1999,2010,2017),c(fitted(fm1)[1],fitted(fm1)[18],fitted(fm1)[23])+20,round(c(fitted(fm1)[1],fitted(fm1)[18],fitted(fm1)[23]),0),col=2,font=1,cex=0.8)
```


```{r CBAinicial_marzo, eval=T, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA_marzo     <- matrix(ncol=nq,nrow=nes)
CBAp_marzo    <- matrix(ncol=1,nrow=1)
CBApstd_marzo <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE03211",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_marzo[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd_marzo[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA_marzo[i,j]<-qnorm(q[j],CBAp_marzo[i],CBApstd_marzo[i])}}

```

```{r Tabla29a_CBAinicial_marzo,eval=T, echo=FALSE, warning=F, include=T, message=F}
tCBA_marzo<-cbind(CBAp_marzo,CBApstd_marzo,CBA_marzo)
colnames(tCBA_marzo)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_marzo)<-c("1991-2007","2008-2012","2013-2021")
kable(t(round(tCBA_marzo,0)))
```

```{r Tabla30_resguardo_marzo, eval=T,echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
buffer[i,j]<-round(1-CBA_marzo[i,j]/CBA_marzo[i,5],2)}}
colnames(buffer)<-c("10%","20%","30%","40%","50%")
row.names(buffer)<-c("1991-2007","2008-2012","2013-2021")
kable(t(buffer))
```

```{r Tabla31_descarte_marzo, eval=T, echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
descarte[i,j]<-round(CBA_marzo[i,j]*0.96,0)}} # descarte 4% (1-0.04 = 0.94)
colnames(descarte)<-c("10%","20%","30%","40%","50%")
row.names(descarte)<-c("1991-2007","2008-2012","2013-2021")
kable(t(descarte))
```

```{r Tabla31b_diferenciasdescarte_marzo, eval=T, echo=FALSE, warning=F, include=T, message=F}

descarte_marzo <- matrix(ncol=nq,nrow=nes)
descarte_sept <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){for(j in 1:nq){	
descarte_marzo[i,j]<-round(CBA_marzo[i,j]*0.96,0)}} # descarte 4% (1-0.04 = 0.94)
for(i in 1:nes){for(j in 1:nq){	
descarte_sept[i,j]<-round(CBA_sept[i,j]*0.94,0)}} # descarte 2% (1-0.06 = 0.94)

tablaincrementos<--round(1-(descarte_marzo/descarte_sept),2)*100
colnames(tablaincrementos)<-c("10%","20%","30%","40%","50%")
row.names(tablaincrementos)<-c("1991-2007","2008-2012","2013-2021")
kable(t(tablaincrementos))

```



## 4.0.  Segunda revisión CBA 2021  (Asesoría de julio 2021)

```{r Fig44,  warning=F, include=T, message=F, echo=FALSE,fig.height=3,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig}
library(strucchange)
years1<-rep3$years
nyears1<-length(years1)
bp.nile <- breakpoints(rep3$Reclutas/1000 ~ 1)
fm0 <- lm(rep3$Reclutas/1000 ~ 1)
fm1 <- lm(rep3$Reclutas/1000 ~ breakfactor(bp.nile, breaks = 2))
quiebres3<-fitted(fm1)

#fs.nile <- Fstats(rep3$Reclutas/1000 ~ 1)
#plot(fs.nile)
#sctest(fs.nile)
#plot(rep3$Reclutas/1000)
#lines(breakpoints(fs.nile))

par(mfrow=c(1,1),mar=c(2,4,1,1))

plot(years1,rep3$Reclutas/1000,type="l",lty=2,pch=19,ylim=c(0,700),
     xaxp=c(1990,2021,31),yaxs="i",
     xlab="",
     ylab="Reclutamientos (miles de millones de ind.)",
     main="Escenarios de reclutamiento proyectado",
     cex.main=0.8,cex.axis=0.8,cex.lab=0.8)

points(years1,rep3$Reclutas/1000,col=1,pch=19)

lines(years1,quiebres3,lwd=2,col=4)

text(c(1999,2010,2017),c(fitted(fm1)[1],
                         fitted(fm1)[18],
                         fitted(fm1)[23])+20,
                 round(c(fitted(fm1)[1],
                         fitted(fm1)[18],
                         fitted(fm1)[23]),0),
                 col=2,font=1,cex=0.8)
```



```{r}

library(strucchange)
library(tidyverse)
library(lubridate)


x1 <- arima.sim(model = list(ar = 0.9), n = 100)
x2 <- arima.sim(model = list(ma = 0.1), n = 100)
x3 <- arima.sim(model = list(ar = 0.5, ma = 0.3), n = 100)

y <- c((1 + x1), x2,(0.5 - x3))

plot.ts(y)

dat <- tibble(ylag0 = y,ylag1 = lag(y))

  qlr <- Fstats(ylag0 ~ ylag1, data = dat)

sctest(qlr, type = "supF")

```

```{r CBAinicial_julio, eval=T, echo=FALSE, warning=F, include=T, message=F}

dir.4<-paste(dir.0,"/CBA_julio/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA_julio     <- matrix(ncol=nq,nrow=nes)
CBAp_julio    <- matrix(ncol=1,nrow=1)
CBApstd_julio <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE07211",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp_julio[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd_julio[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA_julio[i,j]<-qnorm(q[j],CBAp_julio[i],CBApstd_julio[i])}}

```

```{r Tabla29a_CBAinicial_julio,eval=T, echo=FALSE, warning=F, include=T, message=F}
tCBA_julio<-cbind(CBAp_julio,CBApstd_julio,CBA_julio)
colnames(tCBA_julio)<-c("mean","std",c("10%","20%","30%","40%","50%"))
row.names(tCBA_julio)<-c("1991-2007","2008-2012","2013-2021")
kable(t(round(tCBA_julio,0)))
```

```{r Tabla30_resguardo_julio, eval=T,echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
buffer[i,j]<-round(1-CBA_julio[i,j]/CBA_julio[i,5],2)}}
colnames(buffer)<-c("10%","20%","30%","40%","50%")
row.names(buffer)<-c("1991-2007","2008-2012","2013-2021")
kable(t(buffer))
```

```{r Tabla31_descarte_julio, eval=T, echo=FALSE, warning=F, include=T, message=F}
for(i in 1:nes){for(j in 1:nq){	
descarte[i,j]<-round(CBA_julio[i,j]*0.96,0)}} # descarte 4% (1-0.04 = 0.94)
colnames(descarte)<-c("10%","20%","30%","40%","50%")
row.names(descarte)<-c("1991-2007","2008-2012","2013-2021")
kable(t(descarte))
```

```{r Tabla31b_diferenciasdescarte_julio, eval=T, echo=FALSE, warning=F, include=T, message=F}

descarte_julio <- matrix(ncol=nq,nrow=nes)
descarte_sept <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){for(j in 1:nq){	
descarte_julio[i,j]<-round(CBA_julio[i,j]*0.96,0)}} # descarte 4% (1-0.04 = 0.94)
for(i in 1:nes){for(j in 1:nq){	
descarte_sept[i,j]<-round(CBA_sept[i,j]*0.94,0)}} # descarte 2% (1-0.06 = 0.94)

tablaincrementos<--round(1-(descarte_julio/descarte_sept),2)*100
colnames(tablaincrementos)<-c("10%","20%","30%","40%","50%")
row.names(tablaincrementos)<-c("1991-2007","2008-2012","2013-2021")
kable(t(tablaincrementos))

```





```{r Densidad_CBA2021,warning=F, include=T, message=F,eval=T, echo=T,fig.height=4,fig.width=8,fig.align="center",fig.path="Figuras/",dev=c('pdf')}


####################################################
# Asesoría septiembre R1
####################################################
#  densidad de probabilidad
xbs1a <-rnorm(1000, mean = CBAp_sept[1], sd = CBApstd_sept[1])
xbsa  <-seq(min(xbs1a),max(xbs1a),0.5)
ybsa  <-dnorm(xbsa, mean = CBAp_sept[1], sd =CBApstd_sept[1])
icbsa <-qnorm(c(0.10,0.50,0.5),CBAp_sept[1],CBApstd_sept[1])

#distribución probabilidad
xxbsa      <- c(xbsa[xbsa>=icbsa[1]&xbsa<=icbsa[2]],
               rev(xbsa[xbsa>=icbsa[1]&xbsa<=icbsa[2]]))
yybsa      <- c(ybsa[xbsa>=icbsa[1]&xbsa<=icbsa[2]],
               rep(0,length(ybsa[xbsa>=icbsa[1]&xbsa<=icbsa[2]])))

densb_bsa  <- data.frame(x=xxbsa, y=yybsa , t=rep('a', length(xxbsa)), r=seq(1,length(xxbsa),1))

####################################################
# Asesoría septiembre R2
####################################################
#  densidad de probabilidad
xbs1b <-rnorm(1000, mean = CBAp_sept[3], sd = CBApstd_sept[3])
xbsb  <-seq(min(xbs1b),max(xbs1b),0.5)
ybsb  <-dnorm(xbsb, mean = CBAp_sept[3], sd = CBApstd_sept[3])
icbsb <-qnorm(c(0.10,0.50,0.5),CBAp_sept[3],CBApstd_sept[3])

#distribución probabilidad
xxbsb      <- c(xbsb[xbsb>=icbsb[1]&xbsb<=icbsb[2]],
               rev(xbsb[xbsb>=icbsb[1]&xbsb<=icbsb[2]]))
yybsb      <- c(ybsb[xbsb>=icbsb[1]&xbsb<=icbsb[2]],
               rep(0,length(ybsb[xbsb>=icbsb[1]&xbsb<=icbsb[2]])))

densb_bsb  <- data.frame(x=xxbsb, y=yybsb , t=rep('a', length(xxbsb)), r=seq(1,length(xxbsb),1))

plot(xbsa,ybsa ,type="n",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",xlab="CBA 2021 (toneladas)", main="",xlim=c(10000,500000))
polygon(xxbsb,yybsb,col=gray(0.9,0.3),border="gray95")
polygon(xxbsa,yybsa,col=gray(0.9,0.3),border="gray95")
lines(xbsb,ybsb,lwd=1,lty=2,col=1)
lines(xbsa,ybsa,lwd=1,lty=1,col=1)
legend(1000,0.00017,c("CBA2021_Hito1_Rbajo","CBA2021_Hito1_Rreciente"),lwd=c(2,1),col=c(1,2),lty=c(1,1),bty="n",cex=0.8)
text(904.3,0.0022,"Crms")

```







```{r Tabla33_CBA1eraRevision_marzo, echo=FALSE, warning=F, include=T, message=F}
dir.4<-paste(dir.0,"/CBA_marzo/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA     <- matrix(ncol=nq,nrow=nes)
CBAp    <- matrix(ncol=1,nrow=1)
CBApstd <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE03211",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA[i,j]<-qnorm(q[j],CBAp[i],CBApstd[i])}}

```


```{r Tabla_33a,eval=T, warning=F, include=T, message=F, echo=FALSE}
source(paste(dir.fun,"Fn_Estatus_proy.R",sep=""))
setwd(paste(dir.0,"/CBA_marzo/",sep=""))
mfyr<-c(11,21,31)
escR<-"1991-2007"
Estatusproy_marzo("MAE0321",mfyr,escR,year2="2020/21",year3="2021/22")
```

\vspace{-0.7cm}

```{r Tabla_33b,eval=T, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_marzo/",sep=""))
mfyr<-c(12,22,32)
escR<-"2008-2012"
Estatusproy_marzo("MAE0321",mfyr,escR,year2="2020/21",year3="2021/22")

```

\vspace{-0.7cm}

```{r Tabla_33c,eval=T, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_marzo/",sep=""))
mfyr<-c(13,23,33)
escR<-"2013-2021"
Estatusproy_marzo("MAE0321",mfyr,escR,year2="2020/21",year3="2021/22")
```

```{r DF_proymarzo, eval=T,warning=F, include=T, message=F, echo=FALSE,fig.height=2.7,fig.width=2.7}
setwd(paste(dir.0,"/CBA_marzo/",sep=""))

admb_marzo<-"MAE0321"
data2        <- lisread(paste(admb_marzo,".dat",sep=""))#lee los datos de la ultima evaluacion
names(data2) <- str_trim(names(data2), side="right")
dat2         <- data
rep2         <- reptoRlist(paste(admb_marzo,".rep",sep=""))
std2         <- read.table(paste(admb_marzo,".std",sep=""),header=T,sep="",na="NA",fill=T)  

years      <- rep2$years                                                              
nyears     <- length(years)   
Bo         <- rep2$SSBpbr[1]                         # Paso 4: Obtención de Bo
BRMS       <- rep2$SSBpbr[3]                         # Paso 5: Obtención de Brms = 60%SPRo = 55%Bo
FRMS       <- rep2$Fs[2]
BLIM       <- Bo*0.275                              # Paso 6: Obtención de Blim = 20%Bo 
FLIM       <- rep2$Fs[3]                             # Paso 6: Obtención de Flim = 30%SPRo
SpB        <- subset(std2,name=="SSB")$value                                # BD serie histórica de evaluación de stock 
SpBSE      <- subset(std2,name=="SSB")$std                           # desviación estandar BD
ln_Fyr     <- subset(std2,name=="log_Ft")$value                                # logaritmo de Ft
ln_FSE     <- subset(std2,name=="log_Ft")$std                                 # logaritmo de la desviación standar de Ft
Fyr        <- exp(subset(std2,name=="log_Ft")$value)

```

```{r Fig46a_marzo, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy_marzo.R",sep=""))
source(paste(dir.fun,"Fn_ProbEstatus_proy.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1),
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1",
          "Frms*0.9",
          "Frms*0.7"),3)

n<-3
nesc<-c(11,21,31)
admb_marzo<-"MAE0321"

for(i in 1:n){
name<-escR[1]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_marzo",sep=""))

rep     <- reptoRlist(paste(admb_marzo,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_marzo,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 

SpBp    <- subset(std,name=="BD_p0")$value[1]                              
SpBSEp  <- subset(std,name=="BD_p0")$std[1]    
Frmsp    <-rep$Fref

lines(c(rprMARZO,SpBp[1]/BRMS),
      c(FrprMARZO,Frmsp/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(3),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22"),
     cex=c(0.8,0.8))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_marzo",sep=""))
#nesc<-c(11,21,31)
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 1991-2007"
#ProbEstatusproy_marzo("MAE0321",nesc,name,pF,nyears=31)

```

```{r Fig46b_marzo, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}


source(paste(dir.fun,"Fn_DiagramaFase_proy_marzo.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1",
          "Frms*0.9",
          "Frms*0.7"),3)

n<-3
nesc<-c(12,22,32)
admb_marzo<-"MAE0321"

for(i in 1:n){
name<-escR[2]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_marzo",sep=""))

rep     <- reptoRlist(paste(admb_marzo,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_marzo,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 

SpBp    <- subset(std,name=="BD_p0")$value[1]                              
SpBSEp  <- subset(std,name=="BD_p0")$std[1]    
Frmsp    <-rep$Fref

lines(c(rprMARZO,SpBp[1]/BRMS),
      c(FrprMARZO,Frmsp/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(3),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22"),cex=c(0.8,0.8))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

```

```{r Fig46c_marzo, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy_marzo.R",sep=""))


escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1",
          "Frms*0.9",
          "Frms*0.7"),3)

n<-3
nesc<-c(13,23,33)
admb_marzo<-"MAE0321"

for(i in 1:n){
name<-escR[3]

DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,dir.0,etiqueta=F)

setwd(paste(dir.0,"/CBA_marzo",sep=""))

rep     <- reptoRlist(paste(admb_marzo,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_marzo,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 

SpBp    <- subset(std,name=="BD_p0")$value[1]                              
SpBSEp  <- subset(std,name=="BD_p0")$std[1]    
Frmsp    <-rep$Fref

lines(c(rprMARZO,SpBp[1]/BRMS),
      c(FrprMARZO,Frmsp/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(3),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22"),cex=c(0.8,0.8))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

```




```{r Tabla34_CBA1eraRevision_julio, echo=FALSE, warning=F, include=T, message=F}
dir.4<-paste(dir.0,"/CBA_julio/",sep="")

EscRecl<-seq(1,3,1) #escenarios de reclutamiento basado en anÃ¡lisis de quiebres
nes<-length(EscRecl)
q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                    
CBA     <- matrix(ncol=nq,nrow=nes)
CBAp    <- matrix(ncol=1,nrow=1)
CBApstd <- matrix(ncol=1,nrow=1)

buffer   <- matrix(ncol=nq,nrow=nes)
descarte <- matrix(ncol=nq,nrow=nes)

for(i in 1:nes){
	std     <- read.table(paste(dir.4,"MAE07211",i,".std",sep=""),header=T,sep="",na="NA",fill=T)  
	CBAp[i]    <-subset(std,name=="CBA_c0")$value[1]
	CBApstd[i] <-subset(std,name=="CBA_c0")$std[1]
	for(j in 1:nq){	CBA[i,j]<-qnorm(q[j],CBAp[i],CBApstd[i])}}

```


```{r Tabla_34a,eval=T, warning=F, include=T, message=F, echo=FALSE}
source(paste(dir.fun,"Fn_Estatus_proy.R",sep=""))
setwd(paste(dir.0,"/CBA_julio/",sep=""))
mfyr<-c(11,21,31)
escR<-"1991-2007"
Estatusproy_marzo("MAE0721",mfyr,escR,year2="2020/21",year3="2021/22")
```

\vspace{-0.7cm}

```{r Tabla_34b,eval=T, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_julio/",sep=""))
mfyr<-c(12,22,32)
escR<-"2008-2012"
Estatusproy_marzo("MAE0721",mfyr,escR,year2="2020/21",year3="2021/22")

```

\vspace{-0.7cm}

```{r Tabla_34c,eval=T, warning=F, include=T, message=F, echo=FALSE}
setwd(paste(dir.0,"/CBA_julio/",sep=""))
mfyr<-c(13,23,33)
escR<-"2013-2021"
Estatusproy_marzo("MAE0721",mfyr,escR,year2="2020/21",year3="2021/22")
```

```{r DF_proyjulio, eval=T,warning=F, include=T, message=F, echo=FALSE,fig.height=2.7,fig.width=2.7}
setwd(paste(dir.0,"/CBA_julio/",sep=""))

admb_julio<-"MAE0721"
data3        <- lisread(paste(admb_julio,".dat",sep=""))#lee los datos de la ultima evaluacion
names(data3) <- str_trim(names(data3), side="right")
dat3         <- data
rep3         <- reptoRlist(paste(admb_julio,".rep",sep=""))
std3         <- read.table(paste(admb_julio,".std",sep=""),header=T,sep="",na="NA",fill=T)  

years      <- rep3$years                                                              
nyears     <- length(years)   
Bo         <- rep3$SSBpbr[1]                         # Paso 4: Obtención de Bo
BRMS       <- rep3$SSBpbr[3]                         # Paso 5: Obtención de Brms = 60%SPRo = 55%Bo
FRMS       <- rep3$Fs[2]
BLIM       <- Bo*0.275                              # Paso 6: Obtención de Blim = 20%Bo 
FLIM       <- rep3$Fs[3]                             # Paso 6: Obtención de Flim = 30%SPRo
SpB        <- subset(std3,name=="SSB")$value                                # BD serie histórica de evaluación de stock 
SpBSE      <- subset(std3,name=="SSB")$std                           # desviación estandar BD
ln_Fyr     <- subset(std3,name=="log_Ft")$value                                # logaritmo de Ft
ln_FSE     <- subset(std3,name=="log_Ft")$std                                 # logaritmo de la desviación standar de Ft
Fyr        <- exp(subset(std3,name=="log_Ft")$value)

```

```{r Fig47a_julio, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy_marzo.R",sep=""))
source(paste(dir.fun,"Fn_ProbEstatus_proy.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1",
          "Frms*0.9",
          "Frms*0.7"),3)

n<-3
nesc<-c(11,21,31)


for(i in 1:n){
name<-escR[1]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,dir.0,etiqueta=F)

setwd(paste(dir.0,"/CBA_julio",sep=""))

admb_julio<-"MAE0721"
rep     <- reptoRlist(paste(admb_julio,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_julio,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 

SpBp    <- subset(std,name=="BD_p0")$value[1]                              
SpBSEp  <- subset(std,name=="BD_p0")$std[1]    
Frmsp    <-rep$Fref

lines(c(rprJULIO,SpBp[1]/BRMS),
      c(FrprJULIO,Frmsp/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(3),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22"),cex=c(0.8,0.8))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

#setwd(paste(dir.0,"/CBA_marzo",sep=""))
#nesc<-c(11,21,31)
#pF<-c("Frms*1","Frms*0.9","Frms*0.7")
#name<-"Reclprom 1991-2007"
#ProbEstatusproy_marzo("MAE0321",nesc,name,pF,nyears=31)

```

```{r Fig47b_julio, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy_marzo.R",sep=""))

escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1",
          "Frms*0.9",
          "Frms*0.7"),3)
n<-3
nesc<-c(12,22,32)
admb_julio<-"MAE0721"

for(i in 1:n){
name<-escR[2]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_julio",sep=""))

rep     <- reptoRlist(paste(admb_julio,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_julio,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 

SpBp    <- subset(std,name=="BD_p0")$value[1]                              
SpBSEp  <- subset(std,name=="BD_p0")$std[1]    
Frmsp    <-rep$Fref

lines(c(rprJULIO,SpBp[1]/BRMS),
      c(FrprJULIO,Frmsp/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(3),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22"),cex=c(0.8,0.8))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),cex=0.8)
text(1.7,1.9,pF[i],cex=0.8,col=1)
}

```

```{r Fig47c_julio, eval=T, warning=F, include=T, message=F, echo=FALSE,fig.height=2.3,fig.width=2.2,fig.path=dir.Fig,dev=fig}

source(paste(dir.fun,"Fn_DiagramaFase_proy_marzo.R",sep=""))


escR<-c(rep("Reclprom 1991-2007",1), 
        rep("Reclprom 2008-2012",1),
        rep("Reclprom 2013-2021",1))

pF<-rep(c("Frms*1",
          "Frms*0.9",
          "Frms*0.7"),3)
n<-3
nesc<-c(13,23,33)
admb_julio<-"MAE0721"

for(i in 1:n){
name<-escR[3]
DiagramaFase_proy(name,
                  years[30:31],
                  SpB[30:31],
                  SpBSE[30:31],
                  ln_Fyr[30:31],
                  ln_FSE[30:31],
                  FRMS,
                  BRMS,
                  BLIM,
                  FLIM,
                  color=F,
                  dir.0,
                  etiqueta=F)

setwd(paste(dir.0,"/CBA_julio",sep=""))

rep     <- reptoRlist(paste(admb_julio,nesc[i],".rep",sep=""))
std     <- read.table(paste(admb_julio,nesc[i],".std",sep=""),header=T,sep="",na="NA",fill=T) 

SpBp    <- subset(std,name=="BD_p0")$value[1]                              
SpBSEp  <- subset(std,name=="BD_p0")$std[1]    
Frmsp    <-rep$Fref

lines(c(rprJULIO,SpBp[1]/BRMS),
      c(FrprJULIO,Frmsp/FRMS))

points(c(SpBp[1]/BRMS),
       c(Frmsp/FRMS),
       pch=19,col=c(3),cex=c(1))

text((SpBp[1]/BRMS),
     c(Frmsp/FRMS-0.07),
     c("2021/22"),cex=c(0.8,0.8))

text(c(SpB[1]/BRMS,
       SpB[nyears]/BRMS,
       SpB[nyears-1]/BRMS),
     c(Fyr[1]/FRMS-0.05,
       Fyr[nyears]/FRMS-0.05,
       Fyr[nyears-1]/FRMS+0.05),
     c("1990/91","2020/21","2019/20"),cex=0.8)

text(1.7,1.9,pF[i],cex=0.8,col=1)
}

```

\pagebreak

# 5. DISCUSIÓN

```{r Fig48, echo=FALSE,fig.height=5,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig}
years1<-seq(1997,2021,1)
rpr_sard<-c(0.80,0.43,0.38,0.24,0.15,0.31,0.33,0.27,0.16,0.21,0.76,0.67,1.54,1.08,1.17,1.43,1.36,1.07,1.56,1.27,1.03,1.13,1.63,1.04,0.54)
rpr_anch<-c(0.92,0.51,0.56,0.55,0.64,1.09,1.54,1.90,1.63,1.74,1.84,1.30,0.82,0.42,0.18,0.14,0.16,0.21,0.27,0.30,0.45,0.56,0.7,0.97,1.41)
plot(years1,rpr_sard,type="l",ylab="BD/BDrms",xlab="",ylim=c(0,2.5),xaxp=c(1990,2021,31),las=1,lwd=2)
lines(years1,rpr_anch,col=2,lwd=2)
legend(1998,2.5,c("anchoveta centro-sur","sardina común"),col=c(2,1),lwd=c(2,2),bty="n")

```



\normalsize

\normalsize

- ¿Cuánto se sobrepasa el RMS en la captura 2020/21?

Por lo tanto, podríamos concluir que la causa de exceder el objetivo de manejo Frms para el año 2020/21 se debe al remanente de cuota autorizado.

## **¿Cuál es la captura semestral del año biológico 2020/21 y la captura descartada?**


- CBA recomendada 2021 = 251.316 t
- Desembarque 1er semestre 2021 = 22% sobre CBA recomendada (306.406 t)

\pagebreak

## ¿Cuál debería haber sido la captura para un $F_{RMS}$?

La captura 2020/21 al RMS debería ser 359.250 ($C_{RMS}$) - 14.370 (4%descarte) = 344.880 t

Por lo tanto, de las 344.880 t que se podían capturar entre el 2020/21, si consideramos que durante el 2do semestre 2020 se capturaron 69.839 t, entonces, durante el 1er semetre 2021 la captura no debería haber superado las 275.041 t. Se sobrepasó en torno a las 31 mil toneladas la captura biológicamente aceptable 2020/21.


 \pagebreak
 
## Sobre las estacionalidad de las capturas


```{=tex}
\begin{figure}[h!]
\centering
\includegraphics[width=0.65\textwidth]{Figuras/Fig4-1.pdf}
\caption{Capturas mensuales de sardina común realizadas entre 2007-2021, registradas por SERNAPESCA en la zona centro-sur.}
\label{Fig4}
\end{figure}
```

- Revisar la estacionalidad de la captura en año biológico

```{r,eval=F}

prop1ersemestre<-c(0.81,	0.70,	0.65,	0.77,	0.47,	0.81,	0.72,	0.81,	0.85,	0.90,	0.81,	0.90,	0.90,	0.86,	0.88,	0.89,	0.75,	0.89,	0.81,	0.63,	0.67,	0.66,	0.32,	0.80,	0.70,	0.49,	0.66,	0.78,	0.77,	0.69,	0.81)

plot(seq(1991,2021),prop1ersemestre,type="o",ylab="Proporción de captura 1er semestre (año biológico",xlab="Años")

```

 Separar la Captura en año biológico para revisar el efecto de la Captura 2020/21 sobre el cálculo de CBA en año calendario


**Qué pasaría si los usuarios deciden no capturar durante el 2do semestres y traspasar ese remanente de cuota para el 1er semestre del siguiente año???**


 
**cuál es la captura biológicamente aceptable 2021/2022**



